function bytesToUuid(a,b){var c=b||0,d=byteToHex;return[d[a[c++]],d[a[c++]],d[a[c++]],d[a[c++]],"-",d[a[c++]],d[a[c++]],"-",d[a[c++]],d[a[c++]],"-",d[a[c++]],d[a[c++]],"-",d[a[c++]],d[a[c++]],d[a[c++]],d[a[c++]],d[a[c++]],d[a[c++]]].join("")}function uuidv1(a,b,c){var d=b&&c||0,e=b||[];a=a||{};var f=a.node||_nodeId,g=void 0!==a.clockseq?a.clockseq:_clockseq;if(null==f||null==g){var h=rng();null==f&&(f=_nodeId=[1|h[0],h[1],h[2],h[3],h[4],h[5]]),null==g&&(g=_clockseq=16383&(h[6]<<8|h[7]))}var i=void 0!==a.msecs?a.msecs:(new Date).getTime(),j=void 0!==a.nsecs?a.nsecs:_lastNSecs+1,k=i-_lastMSecs+(j-_lastNSecs)/1e4;if(0>k&&void 0===a.clockseq&&(g=g+1&16383),(0>k||i>_lastMSecs)&&void 0===a.nsecs&&(j=0),j>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");_lastMSecs=i,_lastNSecs=j,_clockseq=g,i+=122192928e5;var l=(1e4*(268435455&i)+j)%4294967296;e[d++]=l>>>24&255,e[d++]=l>>>16&255,e[d++]=l>>>8&255,e[d++]=255&l;var m=i/4294967296*1e4&268435455;e[d++]=m>>>8&255,e[d++]=255&m,e[d++]=m>>>24&15|16,e[d++]=m>>>16&255,e[d++]=g>>>8|128,e[d++]=255&g;for(var n=0;6>n;++n)e[d+n]=f[n];return b?b:bytesToUuid(e)}!function(a,b){"function"==typeof define&&define.amd?define(a):"undefined"!=typeof module&&"object"==typeof exports?module.exports=a():b.rangy=a()}(function(){function a(a,b){var c=typeof a[b];return c==u||!(c!=t||!a[b])||"unknown"==c}function b(a,b){return!(typeof a[b]!=t||!a[b])}function c(a,b){return typeof a[b]!=v}function d(a){return function(b,c){for(var d=c.length;d--;)if(!a(b,c[d]))return!1;return!0}}function e(a){return a&&A(a,z)&&C(a,y)}function f(a){return b(a,"body")?a.body:a.getElementsByTagName("body")[0]}function g(b){typeof console!=v&&a(console,"log")&&console.log(b)}function h(a,b){F&&b?alert(a):g(a)}function i(a){H.initialized=!0,H.supported=!1,h("Rangy is not supported in this environment. Reason: "+a,H.config.alertOnFail)}function j(a){h("Rangy warning: "+a,H.config.alertOnWarn)}function k(a){return a.message||a.description||String(a)}function l(){if(F&&!H.initialized){var b,c=!1,d=!1;a(document,"createRange")&&(b=document.createRange(),A(b,x)&&C(b,w)&&(c=!0));var h=f(document);if(!h||"body"!=h.nodeName.toLowerCase())return void i("No body element found");if(h&&a(h,"createTextRange")&&(b=h.createTextRange(),e(b)&&(d=!0)),!c&&!d)return void i("Neither Range nor TextRange are available");H.initialized=!0,H.features={implementsDomRange:c,implementsTextRange:d};var j,l;for(var m in E)(j=E[m])instanceof p&&j.init(j,H);for(var n=0,o=K.length;o>n;++n)try{K[n](H)}catch(q){l="Rangy init listener threw an exception. Continuing. Detail: "+k(q),g(l)}}}function m(a,b,c){c&&(a+=" in module "+c.name),H.warn("DEPRECATED: "+a+" is deprecated. Please use "+b+" instead.")}function n(a,b,c,d){a[b]=function(){return m(b,c,d),a[c].apply(a,G.toArray(arguments))}}function o(a){a=a||window,l();for(var b=0,c=L.length;c>b;++b)L[b](a)}function p(a,b,c){this.name=a,this.dependencies=b,this.initialized=!1,this.supported=!1,this.initializer=c}function q(a,b,c){var d=new p(a,b,function(b){if(!b.initialized){b.initialized=!0;try{c(H,b),b.supported=!0}catch(d){var e="Module '"+a+"' failed to load: "+k(d);g(e),d.stack&&g(d.stack)}}});return E[a]=d,d}function r(){}function s(){}var t="object",u="function",v="undefined",w=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],x=["setStart","setStartBefore","setStartAfter","setEnd","setEndBefore","setEndAfter","collapse","selectNode","selectNodeContents","compareBoundaryPoints","deleteContents","extractContents","cloneContents","insertNode","surroundContents","cloneRange","toString","detach"],y=["boundingHeight","boundingLeft","boundingTop","boundingWidth","htmlText","text"],z=["collapse","compareEndPoints","duplicate","moveToElementText","parentElement","select","setEndPoint","getBoundingClientRect"],A=d(a),B=d(b),C=d(c),D=[].forEach?function(a,b){a.forEach(b)}:function(a,b){for(var c=0,d=a.length;d>c;++c)b(a[c],c)},E={},F=typeof window!=v&&typeof document!=v,G={isHostMethod:a,isHostObject:b,isHostProperty:c,areHostMethods:A,areHostObjects:B,areHostProperties:C,isTextRange:e,getBody:f,forEach:D},H={version:"1.3.0",initialized:!1,isBrowser:F,supported:!0,util:G,features:{},modules:E,config:{alertOnFail:!1,alertOnWarn:!1,preferTextRange:!1,autoInitialize:typeof rangyAutoInitialize==v?!0:rangyAutoInitialize}};H.fail=i,H.warn=j;var I;({}).hasOwnProperty?(G.extend=I=function(a,b,c){var d,e;for(var f in b)b.hasOwnProperty(f)&&(d=a[f],e=b[f],c&&null!==d&&"object"==typeof d&&null!==e&&"object"==typeof e&&I(d,e,!0),a[f]=e);return b.hasOwnProperty("toString")&&(a.toString=b.toString),a},G.createOptions=function(a,b){var c={};return I(c,b),a&&I(c,a),c}):i("hasOwnProperty not supported"),F||i("Rangy can only run in a browser"),function(){var a;if(F){var b=document.createElement("div");b.appendChild(document.createElement("span"));var c=[].slice;try{1==c.call(b.childNodes,0)[0].nodeType&&(a=function(a){return c.call(a,0)})}catch(d){}}a||(a=function(a){for(var b=[],c=0,d=a.length;d>c;++c)b[c]=a[c];return b}),G.toArray=a}();var J;F&&(a(document,"addEventListener")?J=function(a,b,c){a.addEventListener(b,c,!1)}:a(document,"attachEvent")?J=function(a,b,c){a.attachEvent("on"+b,c)}:i("Document does not have required addEventListener or attachEvent method"),G.addListener=J);var K=[];G.deprecationNotice=m,G.createAliasForDeprecatedMethod=n,H.init=l,H.addInitListener=function(a){H.initialized?a(H):K.push(a)};var L=[];H.addShimListener=function(a){L.push(a)},F&&(H.shim=H.createMissingNativeApi=o,n(H,"createMissingNativeApi","shim")),p.prototype={init:function(){for(var a,b,c=this.dependencies||[],d=0,e=c.length;e>d;++d){if(b=c[d],a=E[b],!(a&&a instanceof p))throw new Error("required module '"+b+"' not found");if(a.init(),!a.supported)throw new Error("required module '"+b+"' not supported")}this.initializer(this)},fail:function(a){throw this.initialized=!0,this.supported=!1,new Error(a)},warn:function(a){H.warn("Module "+this.name+": "+a)},deprecationNotice:function(a,b){H.warn("DEPRECATED: "+a+" in module "+this.name+" is deprecated. Please use "+b+" instead")},createError:function(a){return new Error("Error in Rangy "+this.name+" module: "+a)}},H.createModule=function(a){var b,c;2==arguments.length?(b=arguments[1],c=[]):(b=arguments[2],c=arguments[1]);var d=q(a,c,b);H.initialized&&H.supported&&d.init()},H.createCoreModule=function(a,b,c){q(a,b,c)},H.RangePrototype=r,H.rangePrototype=new r,H.selectionPrototype=new s,H.createCoreModule("DomUtil",[],function(a,b){function c(a){var b;return typeof a.namespaceURI==F||null===(b=a.namespaceURI)||"http://www.w3.org/1999/xhtml"==b}function d(a){var b=a.parentNode;return 1==b.nodeType?b:null}function e(a){for(var b=0;a=a.previousSibling;)++b;return b}function f(a){switch(a.nodeType){case 7:case 10:return 0;case 3:case 8:return a.length;default:return a.childNodes.length}}function g(a,b){var c,d=[];for(c=a;c;c=c.parentNode)d.push(c);for(c=b;c;c=c.parentNode)if(K(d,c))return c;return null}function h(a,b,c){for(var d=c?b:b.parentNode;d;){if(d===a)return!0;d=d.parentNode}return!1}function i(a,b){return h(a,b,!0)}function j(a,b,c){for(var d,e=c?a:a.parentNode;e;){if(d=e.parentNode,d===b)return e;e=d}return null}function k(a){var b=a.nodeType;return 3==b||4==b||8==b}function l(a){if(!a)return!1;var b=a.nodeType;return 3==b||8==b}function m(a,b){var c=b.nextSibling,d=b.parentNode;return c?d.insertBefore(a,c):d.appendChild(a),a}function n(a,b,c){var d=a.cloneNode(!1);if(d.deleteData(0,b),a.deleteData(b,a.length-b),m(d,a),c)for(var f,g=0;f=c[g++];)f.node==a&&f.offset>b?(f.node=d,f.offset-=b):f.node==a.parentNode&&f.offset>e(a)&&++f.offset;return d}function o(a){if(9==a.nodeType)return a;if(typeof a.ownerDocument!=F)return a.ownerDocument;if(typeof a.document!=F)return a.document;if(a.parentNode)return o(a.parentNode);throw b.createError("getDocument: no document found for node")}function p(a){var c=o(a);if(typeof c.defaultView!=F)return c.defaultView;if(typeof c.parentWindow!=F)return c.parentWindow;throw b.createError("Cannot get a window object for node")}function q(a){if(typeof a.contentDocument!=F)return a.contentDocument;if(typeof a.contentWindow!=F)return a.contentWindow.document;throw b.createError("getIframeDocument: No Document object found for iframe element")}function r(a){if(typeof a.contentWindow!=F)return a.contentWindow;if(typeof a.contentDocument!=F)return a.contentDocument.defaultView;throw b.createError("getIframeWindow: No Window object found for iframe element")}function s(a){return a&&G.isHostMethod(a,"setTimeout")&&G.isHostObject(a,"document")}function t(a,b,c){var d;if(a?G.isHostProperty(a,"nodeType")?d=1==a.nodeType&&"iframe"==a.tagName.toLowerCase()?q(a):o(a):s(a)&&(d=a.document):d=document,!d)throw b.createError(c+"(): Parameter must be a Window object or DOM node");return d}function u(a){for(var b;b=a.parentNode;)a=b;return a}function v(a,c,d,f){var h,i,k,l,m;if(a==d)return c===f?0:f>c?-1:1;if(h=j(d,a,!0))return c<=e(h)?-1:1;if(h=j(a,d,!0))return e(h)<f?-1:1;if(i=g(a,d),!i)throw new Error("comparePoints error: nodes have no common ancestor");if(k=a===i?i:j(a,i,!0),l=d===i?i:j(d,i,!0),k===l)throw b.createError("comparePoints got to case 4 and childA and childB are the same!");for(m=i.firstChild;m;){if(m===k)return-1;if(m===l)return 1;m=m.nextSibling}}function w(a){var b;try{return b=a.parentNode,!1}catch(c){return!0}}function x(a){if(!a)return"[No node]";if(L&&w(a))return"[Broken node]";if(k(a))return'"'+a.data+'"';if(1==a.nodeType){var b=a.id?' id="'+a.id+'"':"";return"<"+a.nodeName+b+">[index:"+e(a)+",length:"+a.childNodes.length+"]["+(a.innerHTML||"[innerHTML not supported]").slice(0,25)+"]"}return a.nodeName}function y(a){for(var b,c=o(a).createDocumentFragment();b=a.firstChild;)c.appendChild(b);return c}function z(a,b,c){var d=H(a),e=a.createElement("div");e.contentEditable=""+!!c,b&&(e.innerHTML=b);var f=d.firstChild;return f?d.insertBefore(e,f):d.appendChild(e),e}function A(a){return a.parentNode.removeChild(a)}function B(a){this.root=a,this._next=a}function C(a){return new B(a)}function D(a,b){this.node=a,this.offset=b}function E(a){this.code=this[a],this.codeName=a,this.message="DOMException: "+this.codeName}var F="undefined",G=a.util,H=G.getBody;G.areHostMethods(document,["createDocumentFragment","createElement","createTextNode"])||b.fail("document missing a Node creation method"),G.isHostMethod(document,"getElementsByTagName")||b.fail("document missing getElementsByTagName method");var I=document.createElement("div");G.areHostMethods(I,["insertBefore","appendChild","cloneNode"]||!G.areHostObjects(I,["previousSibling","nextSibling","childNodes","parentNode"]))||b.fail("Incomplete Element implementation"),G.isHostProperty(I,"innerHTML")||b.fail("Element is missing innerHTML property");var J=document.createTextNode("test");G.areHostMethods(J,["splitText","deleteData","insertData","appendData","cloneNode"]||!G.areHostObjects(I,["previousSibling","nextSibling","childNodes","parentNode"])||!G.areHostProperties(J,["data"]))||b.fail("Incomplete Text Node implementation");var K=function(a,b){for(var c=a.length;c--;)if(a[c]===b)return!0;return!1},L=!1;!function(){var b=document.createElement("b");b.innerHTML="1";var c=b.firstChild;b.innerHTML="<br />",L=w(c),a.features.crashyTextNodes=L}();var M;typeof window.getComputedStyle!=F?M=function(a,b){return p(a).getComputedStyle(a,null)[b]}:typeof document.documentElement.currentStyle!=F?M=function(a,b){return a.currentStyle?a.currentStyle[b]:""}:b.fail("No means of obtaining computed style properties found"),B.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){var a,b,c=this._current=this._next;if(this._current)if(a=c.firstChild)this._next=a;else{for(b=null;c!==this.root&&!(b=c.nextSibling);)c=c.parentNode;this._next=b}return this._current},detach:function(){this._current=this._next=this.root=null}},D.prototype={equals:function(a){return!!a&&this.node===a.node&&this.offset==a.offset},inspect:function(){return"[DomPosition("+x(this.node)+":"+this.offset+")]"},toString:function(){return this.inspect()}},E.prototype={INDEX_SIZE_ERR:1,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INVALID_STATE_ERR:11,INVALID_NODE_TYPE_ERR:24},E.prototype.toString=function(){return this.message},a.dom={arrayContains:K,isHtmlNamespace:c,parentElement:d,getNodeIndex:e,getNodeLength:f,getCommonAncestor:g,isAncestorOf:h,isOrIsAncestorOf:i,getClosestAncestorIn:j,isCharacterDataNode:k,isTextOrCommentNode:l,insertAfter:m,splitDataNode:n,getDocument:o,getWindow:p,getIframeWindow:r,getIframeDocument:q,getBody:H,isWindow:s,getContentDocument:t,getRootContainer:u,comparePoints:v,isBrokenNode:w,inspectNode:x,getComputedStyleProperty:M,createTestElement:z,removeNode:A,fragmentFromNodeChildren:y,createIterator:C,DomPosition:D},a.DOMException=E}),H.createCoreModule("DomRange",["DomUtil"],function(a,b){function c(a,b){return 3!=a.nodeType&&(P(a,b.startContainer)||P(a,b.endContainer))}function d(a){return a.document||Q(a.startContainer)}function e(a){return W(a.startContainer)}function f(a){return new L(a.parentNode,O(a))}function g(a){return new L(a.parentNode,O(a)+1)}function h(a,b,c){var d=11==a.nodeType?a.firstChild:a;return N(b)?c==b.length?J.insertAfter(a,b):b.parentNode.insertBefore(a,0==c?b:S(b,c)):c>=b.childNodes.length?b.appendChild(a):b.insertBefore(a,b.childNodes[c]),d}function i(a,b,c){if(z(a),z(b),d(b)!=d(a))throw new M("WRONG_DOCUMENT_ERR");var e=R(a.startContainer,a.startOffset,b.endContainer,b.endOffset),f=R(a.endContainer,a.endOffset,b.startContainer,b.startOffset);return c?0>=e&&f>=0:0>e&&f>0}function j(a){for(var b,c,e,f=d(a.range).createDocumentFragment();c=a.next();){if(b=a.isPartiallySelectedSubtree(),c=c.cloneNode(!b),b&&(e=a.getSubtreeIterator(),c.appendChild(j(e)),e.detach()),10==c.nodeType)throw new M("HIERARCHY_REQUEST_ERR");f.appendChild(c)}return f}function k(a,b,c){var d,e;c=c||{stop:!1};for(var f,g;f=a.next();)if(a.isPartiallySelectedSubtree()){if(b(f)===!1)return void(c.stop=!0);if(g=a.getSubtreeIterator(),k(g,b,c),g.detach(),c.stop)return}else for(d=J.createIterator(f);e=d.next();)if(b(e)===!1)return void(c.stop=!0)}function l(a){for(var b;a.next();)a.isPartiallySelectedSubtree()?(b=a.getSubtreeIterator(),l(b),b.detach()):a.remove()}function m(a){for(var b,c,e=d(a.range).createDocumentFragment();b=a.next();){if(a.isPartiallySelectedSubtree()?(b=b.cloneNode(!1),c=a.getSubtreeIterator(),b.appendChild(m(c)),c.detach()):a.remove(),10==b.nodeType)throw new M("HIERARCHY_REQUEST_ERR");e.appendChild(b)}return e}function n(a,b,c){var d,e=!(!b||!b.length),f=!!c;e&&(d=new RegExp("^("+b.join("|")+")$"));var g=[];return k(new p(a,!1),function(b){if((!e||d.test(b.nodeType))&&(!f||c(b))){var h=a.startContainer;if(b!=h||!N(h)||a.startOffset!=h.length){var i=a.endContainer;b==i&&N(i)&&0==a.endOffset||g.push(b)}}}),g}function o(a){var b="undefined"==typeof a.getName?"Range":a.getName();return"["+b+"("+J.inspectNode(a.startContainer)+":"+a.startOffset+", "+J.inspectNode(a.endContainer)+":"+a.endOffset+")]"}function p(a,b){if(this.range=a,this.clonePartiallySelectedTextNodes=b,!a.collapsed){this.sc=a.startContainer,this.so=a.startOffset,this.ec=a.endContainer,this.eo=a.endOffset;var c=a.commonAncestorContainer;this.sc===this.ec&&N(this.sc)?(this.isSingleCharacterDataNode=!0,this._first=this._last=this._next=this.sc):(this._first=this._next=this.sc!==c||N(this.sc)?T(this.sc,c,!0):this.sc.childNodes[this.so],this._last=this.ec!==c||N(this.ec)?T(this.ec,c,!0):this.ec.childNodes[this.eo-1])}}function q(a){return function(b,c){for(var d,e=c?b:b.parentNode;e;){if(d=e.nodeType,V(a,d))return e;e=e.parentNode}return null}}function r(a,b){if(ea(a,b))throw new M("INVALID_NODE_TYPE_ERR")}function s(a,b){if(!V(b,a.nodeType))throw new M("INVALID_NODE_TYPE_ERR")}function t(a,b){if(0>b||b>(N(a)?a.length:a.childNodes.length))throw new M("INDEX_SIZE_ERR")}function u(a,b){if(ca(a,!0)!==ca(b,!0))throw new M("WRONG_DOCUMENT_ERR")}function v(a){if(da(a,!0))throw new M("NO_MODIFICATION_ALLOWED_ERR")}function w(a,b){if(!a)throw new M(b)}function x(a,b){return b<=(N(a)?a.length:a.childNodes.length)}function y(a){return!!a.startContainer&&!!a.endContainer&&!(X&&(J.isBrokenNode(a.startContainer)||J.isBrokenNode(a.endContainer)))&&W(a.startContainer)==W(a.endContainer)&&x(a.startContainer,a.startOffset)&&x(a.endContainer,a.endOffset)}function z(a){if(!y(a))throw new Error("Range error: Range is not valid. This usually happens after DOM mutation. Range: ("+a.inspect()+")")}function A(a,b){z(a);var c=a.startContainer,d=a.startOffset,e=a.endContainer,f=a.endOffset,g=c===e;N(e)&&f>0&&f<e.length&&S(e,f,b),N(c)&&d>0&&d<c.length&&(c=S(c,d,b),g?(f-=d,e=c):e==c.parentNode&&f>=O(c)&&f++,d=0),a.setStartAndEnd(c,d,e,f)}function B(a){z(a);var b=a.commonAncestorContainer.parentNode.cloneNode(!1);return b.appendChild(a.cloneContents()),b.innerHTML}function C(a){a.START_TO_START=ka,a.START_TO_END=la,a.END_TO_END=ma,a.END_TO_START=na,a.NODE_BEFORE=oa,a.NODE_AFTER=pa,a.NODE_BEFORE_AND_AFTER=qa,a.NODE_INSIDE=ra}function D(a){C(a),C(a.prototype)}function E(a,b){return function(){z(this);var c,d,e=this.startContainer,f=this.startOffset,h=this.commonAncestorContainer,i=new p(this,!0);e!==h&&(c=T(e,h,!0),d=g(c),e=d.node,f=d.offset),k(i,v),i.reset();var j=a(i);return i.detach(),b(this,e,f,e,f),j}}function F(b,d){function e(a,b){return function(c){s(c,Z),s(W(c),$);var d=(a?f:g)(c);(b?h:i)(this,d.node,d.offset)}}function h(a,b,c){var e=a.endContainer,f=a.endOffset;(b!==a.startContainer||c!==a.startOffset)&&((W(b)!=W(e)||1==R(b,c,e,f))&&(e=b,f=c),d(a,b,c,e,f))}function i(a,b,c){var e=a.startContainer,f=a.startOffset;(b!==a.endContainer||c!==a.endOffset)&&((W(b)!=W(e)||-1==R(b,c,e,f))&&(e=b,f=c),d(a,e,f,b,c))}var j=function(){};j.prototype=a.rangePrototype,b.prototype=new j,K.extend(b.prototype,{setStart:function(a,b){r(a,!0),t(a,b),h(this,a,b)},setEnd:function(a,b){r(a,!0),t(a,b),i(this,a,b)},setStartAndEnd:function(){var a=arguments,b=a[0],c=a[1],e=b,f=c;switch(a.length){case 3:f=a[2];break;case 4:e=a[2],f=a[3]}d(this,b,c,e,f)},setBoundary:function(a,b,c){this["set"+(c?"Start":"End")](a,b)},setStartBefore:e(!0,!0),setStartAfter:e(!1,!0),setEndBefore:e(!0,!1),setEndAfter:e(!1,!1),collapse:function(a){z(this),a?d(this,this.startContainer,this.startOffset,this.startContainer,this.startOffset):d(this,this.endContainer,this.endOffset,this.endContainer,this.endOffset)},selectNodeContents:function(a){r(a,!0),d(this,a,0,a,U(a))},selectNode:function(a){r(a,!1),s(a,Z);var b=f(a),c=g(a);d(this,b.node,b.offset,c.node,c.offset)},extractContents:E(m,d),deleteContents:E(l,d),canSurroundContents:function(){z(this),v(this.startContainer),v(this.endContainer);var a=new p(this,!0),b=a._first&&c(a._first,this)||a._last&&c(a._last,this);return a.detach(),!b},splitBoundaries:function(){A(this)},splitBoundariesPreservingPositions:function(a){A(this,a)},normalizeBoundaries:function(){z(this);var a,b=this.startContainer,c=this.startOffset,e=this.endContainer,f=this.endOffset,g=function(a){var b=a.nextSibling;b&&b.nodeType==a.nodeType&&(e=a,f=a.length,a.appendData(b.data),Y(b))},h=function(a){var d=a.previousSibling;if(d&&d.nodeType==a.nodeType){b=a;var g=a.length;if(c=d.length,a.insertData(0,d.data),Y(d),b==e)f+=c,e=b;else if(e==a.parentNode){var h=O(a);f==h?(e=a,f=g):f>h&&f--}}},i=!0;if(N(e))f==e.length?g(e):0==f&&(a=e.previousSibling,a&&a.nodeType==e.nodeType&&(f=a.length,b==e&&(i=!1),a.appendData(e.data),Y(e),e=a));else{if(f>0){var j=e.childNodes[f-1];j&&N(j)&&g(j)}i=!this.collapsed}if(i){if(N(b))0==c?h(b):c==b.length&&(a=b.nextSibling,a&&a.nodeType==b.nodeType&&(e==a&&(e=b,f+=b.length),b.appendData(a.data),Y(a)));else if(c<b.childNodes.length){var k=b.childNodes[c];k&&N(k)&&h(k)}}else b=e,c=f;d(this,b,c,e,f)},collapseToPoint:function(a,b){r(a,!0),t(a,b),this.setStartAndEnd(a,b)}}),D(b)}function G(a){a.collapsed=a.startContainer===a.endContainer&&a.startOffset===a.endOffset,a.commonAncestorContainer=a.collapsed?a.startContainer:J.getCommonAncestor(a.startContainer,a.endContainer)}function H(a,b,c,d,e){a.startContainer=b,a.startOffset=c,a.endContainer=d,a.endOffset=e,a.document=J.getDocument(b),G(a)}function I(a){this.startContainer=a,this.startOffset=0,this.endContainer=a,this.endOffset=0,this.document=a,G(this)}var J=a.dom,K=a.util,L=J.DomPosition,M=a.DOMException,N=J.isCharacterDataNode,O=J.getNodeIndex,P=J.isOrIsAncestorOf,Q=J.getDocument,R=J.comparePoints,S=J.splitDataNode,T=J.getClosestAncestorIn,U=J.getNodeLength,V=J.arrayContains,W=J.getRootContainer,X=a.features.crashyTextNodes,Y=J.removeNode;p.prototype={_current:null,_next:null,_first:null,_last:null,isSingleCharacterDataNode:!1,reset:function(){this._current=null,this._next=this._first},hasNext:function(){return!!this._next},next:function(){var a=this._current=this._next;return a&&(this._next=a!==this._last?a.nextSibling:null,N(a)&&this.clonePartiallySelectedTextNodes&&(a===this.ec&&(a=a.cloneNode(!0)).deleteData(this.eo,a.length-this.eo),this._current===this.sc&&(a=a.cloneNode(!0)).deleteData(0,this.so))),a},remove:function(){var a,b,c=this._current;!N(c)||c!==this.sc&&c!==this.ec?c.parentNode&&Y(c):(a=c===this.sc?this.so:0,b=c===this.ec?this.eo:c.length,a!=b&&c.deleteData(a,b-a))},isPartiallySelectedSubtree:function(){var a=this._current;return c(a,this.range)},getSubtreeIterator:function(){var a;if(this.isSingleCharacterDataNode)a=this.range.cloneRange(),a.collapse(!1);else{a=new I(d(this.range));var b=this._current,c=b,e=0,f=b,g=U(b);P(b,this.sc)&&(c=this.sc,e=this.so),P(b,this.ec)&&(f=this.ec,g=this.eo),H(a,c,e,f,g)}return new p(a,this.clonePartiallySelectedTextNodes)},detach:function(){this.range=this._current=this._next=this._first=this._last=this.sc=this.so=this.ec=this.eo=null}};var Z=[1,3,4,5,7,8,10],$=[2,9,11],_=[5,6,10,12],aa=[1,3,4,5,7,8,10,11],ba=[1,3,4,5,7,8],ca=q([9,11]),da=q(_),ea=q([6,10,12]),fa=document.createElement("style"),ga=!1;try{fa.innerHTML="<b>x</b>",ga=3==fa.firstChild.nodeType}catch(ha){}a.features.htmlParsingConforms=ga;var ia=ga?function(a){var b=this.startContainer,c=Q(b);if(!b)throw new M("INVALID_STATE_ERR");var d=null;return 1==b.nodeType?d=b:N(b)&&(d=J.parentElement(b)),d=null===d||"HTML"==d.nodeName&&J.isHtmlNamespace(Q(d).documentElement)&&J.isHtmlNamespace(d)?c.createElement("body"):d.cloneNode(!1),d.innerHTML=a,J.fragmentFromNodeChildren(d)}:function(a){var b=d(this),c=b.createElement("body");return c.innerHTML=a,J.fragmentFromNodeChildren(c)},ja=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],ka=0,la=1,ma=2,na=3,oa=0,pa=1,qa=2,ra=3;K.extend(a.rangePrototype,{compareBoundaryPoints:function(a,b){z(this),u(this.startContainer,b.startContainer);var c,d,e,f,g=a==na||a==ka?"start":"end",h=a==la||a==ka?"start":"end";return c=this[g+"Container"],d=this[g+"Offset"],e=b[h+"Container"],f=b[h+"Offset"],R(c,d,e,f)},insertNode:function(a){if(z(this),s(a,aa),v(this.startContainer),P(a,this.startContainer))throw new M("HIERARCHY_REQUEST_ERR");var b=h(a,this.startContainer,this.startOffset);this.setStartBefore(b)},cloneContents:function(){z(this);var a,b;if(this.collapsed)return d(this).createDocumentFragment();if(this.startContainer===this.endContainer&&N(this.startContainer))return a=this.startContainer.cloneNode(!0),a.data=a.data.slice(this.startOffset,this.endOffset),b=d(this).createDocumentFragment(),b.appendChild(a),b;var c=new p(this,!0);return a=j(c),c.detach(),a},canSurroundContents:function(){z(this),v(this.startContainer),v(this.endContainer);var a=new p(this,!0),b=a._first&&c(a._first,this)||a._last&&c(a._last,this);return a.detach(),!b},surroundContents:function(a){if(s(a,ba),!this.canSurroundContents())throw new M("INVALID_STATE_ERR");var b=this.extractContents();if(a.hasChildNodes())for(;a.lastChild;)a.removeChild(a.lastChild);h(a,this.startContainer,this.startOffset),a.appendChild(b),this.selectNode(a)},cloneRange:function(){z(this);for(var a,b=new I(d(this)),c=ja.length;c--;)a=ja[c],b[a]=this[a];return b},toString:function(){z(this);var a=this.startContainer;if(a===this.endContainer&&N(a))return 3==a.nodeType||4==a.nodeType?a.data.slice(this.startOffset,this.endOffset):"";var b=[],c=new p(this,!0);return k(c,function(a){(3==a.nodeType||4==a.nodeType)&&b.push(a.data)}),c.detach(),b.join("")},compareNode:function(a){z(this);var b=a.parentNode,c=O(a);if(!b)throw new M("NOT_FOUND_ERR");var d=this.comparePoint(b,c),e=this.comparePoint(b,c+1);return 0>d?e>0?qa:oa:e>0?pa:ra},comparePoint:function(a,b){return z(this),w(a,"HIERARCHY_REQUEST_ERR"),u(a,this.startContainer),R(a,b,this.startContainer,this.startOffset)<0?-1:R(a,b,this.endContainer,this.endOffset)>0?1:0},createContextualFragment:ia,toHtml:function(){return B(this)},intersectsNode:function(a,b){if(z(this),W(a)!=e(this))return!1;var c=a.parentNode,d=O(a);if(!c)return!0;var f=R(c,d,this.endContainer,this.endOffset),g=R(c,d+1,this.startContainer,this.startOffset);return b?0>=f&&g>=0:0>f&&g>0},isPointInRange:function(a,b){return z(this),w(a,"HIERARCHY_REQUEST_ERR"),u(a,this.startContainer),R(a,b,this.startContainer,this.startOffset)>=0&&R(a,b,this.endContainer,this.endOffset)<=0},intersectsRange:function(a){return i(this,a,!1)},intersectsOrTouchesRange:function(a){return i(this,a,!0)},intersection:function(a){if(this.intersectsRange(a)){var b=R(this.startContainer,this.startOffset,a.startContainer,a.startOffset),c=R(this.endContainer,this.endOffset,a.endContainer,a.endOffset),d=this.cloneRange();return-1==b&&d.setStart(a.startContainer,a.startOffset),1==c&&d.setEnd(a.endContainer,a.endOffset),d}return null},union:function(a){if(this.intersectsOrTouchesRange(a)){var b=this.cloneRange();return-1==R(a.startContainer,a.startOffset,this.startContainer,this.startOffset)&&b.setStart(a.startContainer,a.startOffset),1==R(a.endContainer,a.endOffset,this.endContainer,this.endOffset)&&b.setEnd(a.endContainer,a.endOffset),b}throw new M("Ranges do not intersect")},containsNode:function(a,b){return b?this.intersectsNode(a,!1):this.compareNode(a)==ra},containsNodeContents:function(a){return this.comparePoint(a,0)>=0&&this.comparePoint(a,U(a))<=0},containsRange:function(a){var b=this.intersection(a);return null!==b&&a.equals(b)},containsNodeText:function(a){var b=this.cloneRange();b.selectNode(a);var c=b.getNodes([3]);if(c.length>0){b.setStart(c[0],0);var d=c.pop();return b.setEnd(d,d.length),this.containsRange(b)}return this.containsNodeContents(a)},getNodes:function(a,b){return z(this),n(this,a,b)},getDocument:function(){return d(this)},collapseBefore:function(a){this.setEndBefore(a),this.collapse(!1)},collapseAfter:function(a){this.setStartAfter(a),this.collapse(!0)},getBookmark:function(b){var c=d(this),e=a.createRange(c);b=b||J.getBody(c),e.selectNodeContents(b);var f=this.intersection(e),g=0,h=0;return f&&(e.setEnd(f.startContainer,f.startOffset),g=e.toString().length,h=g+f.toString().length),{start:g,end:h,containerNode:b}},moveToBookmark:function(a){var b=a.containerNode,c=0;this.setStart(b,0),this.collapse(!0);for(var d,e,f,g,h=[b],i=!1,j=!1;!j&&(d=h.pop());)if(3==d.nodeType)e=c+d.length,!i&&a.start>=c&&a.start<=e&&(this.setStart(d,a.start-c),i=!0),i&&a.end>=c&&a.end<=e&&(this.setEnd(d,a.end-c),j=!0),c=e;else for(g=d.childNodes,f=g.length;f--;)h.push(g[f])},getName:function(){return"DomRange"},equals:function(a){return I.rangesEqual(this,a)},isValid:function(){return y(this)},inspect:function(){return o(this)},detach:function(){}}),F(I,H),K.extend(I,{rangeProperties:ja,RangeIterator:p,copyComparisonConstants:D,createPrototypeRange:F,inspect:o,toHtml:B,getRangeDocument:d,rangesEqual:function(a,b){return a.startContainer===b.startContainer&&a.startOffset===b.startOffset&&a.endContainer===b.endContainer&&a.endOffset===b.endOffset}}),a.DomRange=I}),H.createCoreModule("WrappedRange",["DomRange"],function(a,b){var c,d,e=a.dom,f=a.util,g=e.DomPosition,h=a.DomRange,i=e.getBody,j=e.getContentDocument,k=e.isCharacterDataNode;if(a.features.implementsDomRange&&!function(){function d(a){for(var b,c=m.length;c--;)b=m[c],a[b]=a.nativeRange[b];a.collapsed=a.startContainer===a.endContainer&&a.startOffset===a.endOffset}function g(a,b,c,d,e){var f=a.startContainer!==b||a.startOffset!=c,g=a.endContainer!==d||a.endOffset!=e,h=!a.equals(a.nativeRange);(f||g||h)&&(a.setEnd(d,e),a.setStart(b,c))}var k,l,m=h.rangeProperties;c=function(a){if(!a)throw b.createError("WrappedRange: Range must be specified");this.nativeRange=a,d(this)},h.createPrototypeRange(c,g),k=c.prototype,k.selectNode=function(a){this.nativeRange.selectNode(a),d(this)},k.cloneContents=function(){return this.nativeRange.cloneContents()},k.surroundContents=function(a){this.nativeRange.surroundContents(a),d(this)},k.collapse=function(a){this.nativeRange.collapse(a),d(this)},k.cloneRange=function(){return new c(this.nativeRange.cloneRange())},k.refresh=function(){d(this)},k.toString=function(){return this.nativeRange.toString()};var n=document.createTextNode("test");i(document).appendChild(n);var o=document.createRange();o.setStart(n,0),o.setEnd(n,0);try{o.setStart(n,1),k.setStart=function(a,b){this.nativeRange.setStart(a,b),d(this)},k.setEnd=function(a,b){this.nativeRange.setEnd(a,b),d(this)},l=function(a){return function(b){this.nativeRange[a](b),d(this)}}}catch(p){k.setStart=function(a,b){try{this.nativeRange.setStart(a,b)}catch(c){this.nativeRange.setEnd(a,b),this.nativeRange.setStart(a,b)}d(this)},k.setEnd=function(a,b){try{this.nativeRange.setEnd(a,b)}catch(c){this.nativeRange.setStart(a,b),this.nativeRange.setEnd(a,b)}d(this)},l=function(a,b){return function(c){try{this.nativeRange[a](c)}catch(e){this.nativeRange[b](c),this.nativeRange[a](c)}d(this)}}}k.setStartBefore=l("setStartBefore","setEndBefore"),k.setStartAfter=l("setStartAfter","setEndAfter"),k.setEndBefore=l("setEndBefore","setStartBefore"),k.setEndAfter=l("setEndAfter","setStartAfter"),k.selectNodeContents=function(a){this.setStartAndEnd(a,0,e.getNodeLength(a))},o.selectNodeContents(n),o.setEnd(n,3);var q=document.createRange();q.selectNodeContents(n),q.setEnd(n,4),q.setStart(n,2),-1==o.compareBoundaryPoints(o.START_TO_END,q)&&1==o.compareBoundaryPoints(o.END_TO_START,q)?k.compareBoundaryPoints=function(a,b){return b=b.nativeRange||b,a==b.START_TO_END?a=b.END_TO_START:a==b.END_TO_START&&(a=b.START_TO_END),this.nativeRange.compareBoundaryPoints(a,b)}:k.compareBoundaryPoints=function(a,b){return this.nativeRange.compareBoundaryPoints(a,b.nativeRange||b)};var r=document.createElement("div");r.innerHTML="123";var s=r.firstChild,t=i(document);t.appendChild(r),o.setStart(s,1),o.setEnd(s,2),o.deleteContents(),"13"==s.data&&(k.deleteContents=function(){this.nativeRange.deleteContents(),d(this)},k.extractContents=function(){var a=this.nativeRange.extractContents();return d(this),a}),t.removeChild(r),t=null,f.isHostMethod(o,"createContextualFragment")&&(k.createContextualFragment=function(a){return this.nativeRange.createContextualFragment(a)}),i(document).removeChild(n),k.getName=function(){return"WrappedRange"},a.WrappedRange=c,a.createNativeRange=function(a){return a=j(a,b,"createNativeRange"),a.createRange()}}(),a.features.implementsTextRange){var l=function(a){var b=a.parentElement(),c=a.duplicate();c.collapse(!0);var d=c.parentElement();c=a.duplicate(),c.collapse(!1);var f=c.parentElement(),g=d==f?d:e.getCommonAncestor(d,f);return g==b?g:e.getCommonAncestor(b,g)},m=function(a){return 0==a.compareEndPoints("StartToEnd",a)},n=function(a,b,c,d,f){var h=a.duplicate();h.collapse(c);var i=h.parentElement();if(e.isOrIsAncestorOf(b,i)||(i=b),!i.canHaveHTML){var j=new g(i.parentNode,e.getNodeIndex(i));return{boundaryPosition:j,nodeInfo:{nodeIndex:j.offset,containerElement:j.node}}}var l=e.getDocument(i).createElement("span");l.parentNode&&e.removeNode(l);for(var m,n,o,p,q,r=c?"StartToStart":"StartToEnd",s=f&&f.containerElement==i?f.nodeIndex:0,t=i.childNodes.length,u=t,v=u;;){if(v==t?i.appendChild(l):i.insertBefore(l,i.childNodes[v]),h.moveToElementText(l),
m=h.compareEndPoints(r,a),0==m||s==u)break;if(-1==m){if(u==s+1)break;s=v}else u=u==s+1?s:v;v=Math.floor((s+u)/2),i.removeChild(l)}if(q=l.nextSibling,-1==m&&q&&k(q)){h.setEndPoint(c?"EndToStart":"EndToEnd",a);var w;if(/[\r\n]/.test(q.data)){var x=h.duplicate(),y=x.text.replace(/\r\n/g,"\r").length;for(w=x.moveStart("character",y);-1==(m=x.compareEndPoints("StartToEnd",x));)w++,x.moveStart("character",1)}else w=h.text.length;p=new g(q,w)}else n=(d||!c)&&l.previousSibling,o=(d||c)&&l.nextSibling,p=o&&k(o)?new g(o,0):n&&k(n)?new g(n,n.data.length):new g(i,e.getNodeIndex(l));return e.removeNode(l),{boundaryPosition:p,nodeInfo:{nodeIndex:v,containerElement:i}}},o=function(a,b){var c,d,f,g,h=a.offset,j=e.getDocument(a.node),l=i(j).createTextRange(),m=k(a.node);return m?(c=a.node,d=c.parentNode):(g=a.node.childNodes,c=h<g.length?g[h]:null,d=a.node),f=j.createElement("span"),f.innerHTML="&#feff;",c?d.insertBefore(f,c):d.appendChild(f),l.moveToElementText(f),l.collapse(!b),d.removeChild(f),m&&l[b?"moveStart":"moveEnd"]("character",h),l};d=function(a){this.textRange=a,this.refresh()},d.prototype=new h(document),d.prototype.refresh=function(){var a,b,c,d=l(this.textRange);m(this.textRange)?b=a=n(this.textRange,d,!0,!0).boundaryPosition:(c=n(this.textRange,d,!0,!1),a=c.boundaryPosition,b=n(this.textRange,d,!1,!1,c.nodeInfo).boundaryPosition),this.setStart(a.node,a.offset),this.setEnd(b.node,b.offset)},d.prototype.getName=function(){return"WrappedTextRange"},h.copyComparisonConstants(d);var p=function(a){if(a.collapsed)return o(new g(a.startContainer,a.startOffset),!0);var b=o(new g(a.startContainer,a.startOffset),!0),c=o(new g(a.endContainer,a.endOffset),!1),d=i(h.getRangeDocument(a)).createTextRange();return d.setEndPoint("StartToStart",b),d.setEndPoint("EndToEnd",c),d};if(d.rangeToTextRange=p,d.prototype.toTextRange=function(){return p(this)},a.WrappedTextRange=d,!a.features.implementsDomRange||a.config.preferTextRange){var q=function(a){return a("return this;")()}(Function);"undefined"==typeof q.Range&&(q.Range=d),a.createNativeRange=function(a){return a=j(a,b,"createNativeRange"),i(a).createTextRange()},a.WrappedRange=d}}a.createRange=function(c){return c=j(c,b,"createRange"),new a.WrappedRange(a.createNativeRange(c))},a.createRangyRange=function(a){return a=j(a,b,"createRangyRange"),new h(a)},f.createAliasForDeprecatedMethod(a,"createIframeRange","createRange"),f.createAliasForDeprecatedMethod(a,"createIframeRangyRange","createRangyRange"),a.addShimListener(function(b){var c=b.document;"undefined"==typeof c.createRange&&(c.createRange=function(){return a.createRange(c)}),c=b=null})}),H.createCoreModule("WrappedSelection",["DomRange","WrappedRange"],function(a,b){function c(a){return"string"==typeof a?/^backward(s)?$/i.test(a):!!a}function d(a,c){if(a){if(C.isWindow(a))return a;if(a instanceof r)return a.win;var d=C.getContentDocument(a,b,c);return C.getWindow(d)}return window}function e(a){return d(a,"getWinSelection").getSelection()}function f(a){return d(a,"getDocSelection").document.selection}function g(a){var b=!1;return a.anchorNode&&(b=1==C.comparePoints(a.anchorNode,a.anchorOffset,a.focusNode,a.focusOffset)),b}function h(a,b,c){var d=c?"end":"start",e=c?"start":"end";a.anchorNode=b[d+"Container"],a.anchorOffset=b[d+"Offset"],a.focusNode=b[e+"Container"],a.focusOffset=b[e+"Offset"]}function i(a){var b=a.nativeSelection;a.anchorNode=b.anchorNode,a.anchorOffset=b.anchorOffset,a.focusNode=b.focusNode,a.focusOffset=b.focusOffset}function j(a){a.anchorNode=a.focusNode=null,a.anchorOffset=a.focusOffset=0,a.rangeCount=0,a.isCollapsed=!0,a._ranges.length=0}function k(b){var c;return b instanceof F?(c=a.createNativeRange(b.getDocument()),c.setEnd(b.endContainer,b.endOffset),c.setStart(b.startContainer,b.startOffset)):b instanceof G?c=b.nativeRange:J.implementsDomRange&&b instanceof C.getWindow(b.startContainer).Range&&(c=b),c}function l(a){if(!a.length||1!=a[0].nodeType)return!1;for(var b=1,c=a.length;c>b;++b)if(!C.isAncestorOf(a[0],a[b]))return!1;return!0}function m(a){var c=a.getNodes();if(!l(c))throw b.createError("getSingleElementFromRange: range "+a.inspect()+" did not consist of a single element");return c[0]}function n(a){return!!a&&"undefined"!=typeof a.text}function o(a,b){var c=new G(b);a._ranges=[c],h(a,c,!1),a.rangeCount=1,a.isCollapsed=c.collapsed}function p(b){if(b._ranges.length=0,"None"==b.docSelection.type)j(b);else{var c=b.docSelection.createRange();if(n(c))o(b,c);else{b.rangeCount=c.length;for(var d,e=L(c.item(0)),f=0;f<b.rangeCount;++f)d=a.createRange(e),d.selectNode(c.item(f)),b._ranges.push(d);b.isCollapsed=1==b.rangeCount&&b._ranges[0].collapsed,h(b,b._ranges[b.rangeCount-1],!1)}}}function q(a,c){for(var d=a.docSelection.createRange(),e=m(c),f=L(d.item(0)),g=M(f).createControlRange(),h=0,i=d.length;i>h;++h)g.add(d.item(h));try{g.add(e)}catch(j){throw b.createError("addRange(): Element within the specified Range could not be added to control selection (does it have layout?)")}g.select(),p(a)}function r(a,b,c){this.nativeSelection=a,this.docSelection=b,this._ranges=[],this.win=c,this.refresh()}function s(a){a.win=a.anchorNode=a.focusNode=a._ranges=null,a.rangeCount=a.anchorOffset=a.focusOffset=0,a.detached=!0}function t(a,b){for(var c,d,e=ba.length;e--;)if(c=ba[e],d=c.selection,"deleteAll"==b)s(d);else if(c.win==a)return"delete"==b?(ba.splice(e,1),!0):d;return"deleteAll"==b&&(ba.length=0),null}function u(a,c){for(var d,e=L(c[0].startContainer),f=M(e).createControlRange(),g=0,h=c.length;h>g;++g){d=m(c[g]);try{f.add(d)}catch(i){throw b.createError("setRanges(): Element within one of the specified Ranges could not be added to control selection (does it have layout?)")}}f.select(),p(a)}function v(a,b){if(a.win.document!=L(b))throw new H("WRONG_DOCUMENT_ERR")}function w(b){return function(c,d){var e;this.rangeCount?(e=this.getRangeAt(0),e["set"+(b?"Start":"End")](c,d)):(e=a.createRange(this.win.document),e.setStartAndEnd(c,d)),this.setSingleRange(e,this.isBackward())}}function x(a){var b=[],c=new I(a.anchorNode,a.anchorOffset),d=new I(a.focusNode,a.focusOffset),e="function"==typeof a.getName?a.getName():"Selection";if("undefined"!=typeof a.rangeCount)for(var f=0,g=a.rangeCount;g>f;++f)b[f]=F.inspect(a.getRangeAt(f));return"["+e+"(Ranges: "+b.join(", ")+")(anchor: "+c.inspect()+", focus: "+d.inspect()+"]"}a.config.checkSelectionRanges=!0;var y,z,A="boolean",B="number",C=a.dom,D=a.util,E=D.isHostMethod,F=a.DomRange,G=a.WrappedRange,H=a.DOMException,I=C.DomPosition,J=a.features,K="Control",L=C.getDocument,M=C.getBody,N=F.rangesEqual,O=E(window,"getSelection"),P=D.isHostObject(document,"selection");J.implementsWinGetSelection=O,J.implementsDocSelection=P;var Q=P&&(!O||a.config.preferTextRange);if(Q)y=f,a.isSelectionValid=function(a){var b=d(a,"isSelectionValid").document,c=b.selection;return"None"!=c.type||L(c.createRange().parentElement())==b};else{if(!O)return b.fail("Neither document.selection or window.getSelection() detected."),!1;y=e,a.isSelectionValid=function(){return!0}}a.getNativeSelection=y;var R=y();if(!R)return b.fail("Native selection was null (possibly issue 138?)"),!1;var S=a.createNativeRange(document),T=M(document),U=D.areHostProperties(R,["anchorNode","focusNode","anchorOffset","focusOffset"]);J.selectionHasAnchorAndFocus=U;var V=E(R,"extend");J.selectionHasExtend=V;var W=typeof R.rangeCount==B;J.selectionHasRangeCount=W;var X=!1,Y=!0,Z=V?function(b,c){var d=F.getRangeDocument(c),e=a.createRange(d);e.collapseToPoint(c.endContainer,c.endOffset),b.addRange(k(e)),b.extend(c.startContainer,c.startOffset)}:null;D.areHostMethods(R,["addRange","getRangeAt","removeAllRanges"])&&typeof R.rangeCount==B&&J.implementsDomRange&&!function(){var b=window.getSelection();if(b){for(var c=b.rangeCount,d=c>1,e=[],f=g(b),h=0;c>h;++h)e[h]=b.getRangeAt(h);var i=C.createTestElement(document,"",!1),j=i.appendChild(document.createTextNode("\xa0\xa0\xa0")),k=document.createRange();if(k.setStart(j,1),k.collapse(!0),b.removeAllRanges(),b.addRange(k),Y=1==b.rangeCount,b.removeAllRanges(),!d){var l=window.navigator.appVersion.match(/Chrome\/(.*?) /);if(l&&parseInt(l[1])>=36)X=!1;else{var m=k.cloneRange();k.setStart(j,0),m.setEnd(j,3),m.setStart(j,2),b.addRange(k),b.addRange(m),X=2==b.rangeCount}}for(C.removeNode(i),b.removeAllRanges(),h=0;c>h;++h)0==h&&f?Z?Z(b,e[h]):(a.warn("Rangy initialization: original selection was backwards but selection has been restored forwards because the browser does not support Selection.extend"),b.addRange(e[h])):b.addRange(e[h])}}(),J.selectionSupportsMultipleRanges=X,J.collapsedNonEditableSelectionsSupported=Y;var $,_=!1;T&&E(T,"createControlRange")&&($=T.createControlRange(),D.areHostProperties($,["item","add"])&&(_=!0)),J.implementsControlRange=_,z=U?function(a){return a.anchorNode===a.focusNode&&a.anchorOffset===a.focusOffset}:function(a){return a.rangeCount?a.getRangeAt(a.rangeCount-1).collapsed:!1};var aa;E(R,"getRangeAt")?aa=function(a,b){try{return a.getRangeAt(b)}catch(c){return null}}:U&&(aa=function(b){var c=L(b.anchorNode),d=a.createRange(c);return d.setStartAndEnd(b.anchorNode,b.anchorOffset,b.focusNode,b.focusOffset),d.collapsed!==this.isCollapsed&&d.setStartAndEnd(b.focusNode,b.focusOffset,b.anchorNode,b.anchorOffset),d}),r.prototype=a.selectionPrototype;var ba=[],ca=function(a){if(a&&a instanceof r)return a.refresh(),a;a=d(a,"getNativeSelection");var b=t(a),c=y(a),e=P?f(a):null;return b?(b.nativeSelection=c,b.docSelection=e,b.refresh()):(b=new r(c,e,a),ba.push({win:a,selection:b})),b};a.getSelection=ca,D.createAliasForDeprecatedMethod(a,"getIframeSelection","getSelection");var da=r.prototype;if(!Q&&U&&D.areHostMethods(R,["removeAllRanges","addRange"])){da.removeAllRanges=function(){this.nativeSelection.removeAllRanges(),j(this)};var ea=function(a,b){Z(a.nativeSelection,b),a.refresh()};W?da.addRange=function(b,d){if(_&&P&&this.docSelection.type==K)q(this,b);else if(c(d)&&V)ea(this,b);else{var e;X?e=this.rangeCount:(this.removeAllRanges(),e=0);var f=k(b).cloneRange();try{this.nativeSelection.addRange(f)}catch(g){}if(this.rangeCount=this.nativeSelection.rangeCount,this.rangeCount==e+1){if(a.config.checkSelectionRanges){var i=aa(this.nativeSelection,this.rangeCount-1);i&&!N(i,b)&&(b=new G(i))}this._ranges[this.rangeCount-1]=b,h(this,b,ha(this.nativeSelection)),this.isCollapsed=z(this)}else this.refresh()}}:da.addRange=function(a,b){c(b)&&V?ea(this,a):(this.nativeSelection.addRange(k(a)),this.refresh())},da.setRanges=function(a){if(_&&P&&a.length>1)u(this,a);else{this.removeAllRanges();for(var b=0,c=a.length;c>b;++b)this.addRange(a[b])}}}else{if(!(E(R,"empty")&&E(S,"select")&&_&&Q))return b.fail("No means of selecting a Range or TextRange was found"),!1;da.removeAllRanges=function(){try{if(this.docSelection.empty(),"None"!=this.docSelection.type){var a;if(this.anchorNode)a=L(this.anchorNode);else if(this.docSelection.type==K){var b=this.docSelection.createRange();b.length&&(a=L(b.item(0)))}if(a){var c=M(a).createTextRange();c.select(),this.docSelection.empty()}}}catch(d){}j(this)},da.addRange=function(b){this.docSelection.type==K?q(this,b):(a.WrappedTextRange.rangeToTextRange(b).select(),this._ranges[0]=b,this.rangeCount=1,this.isCollapsed=this._ranges[0].collapsed,h(this,b,!1))},da.setRanges=function(a){this.removeAllRanges();var b=a.length;b>1?u(this,a):b&&this.addRange(a[0])}}da.getRangeAt=function(a){if(0>a||a>=this.rangeCount)throw new H("INDEX_SIZE_ERR");return this._ranges[a].cloneRange()};var fa;if(Q)fa=function(b){var c;a.isSelectionValid(b.win)?c=b.docSelection.createRange():(c=M(b.win.document).createTextRange(),c.collapse(!0)),b.docSelection.type==K?p(b):n(c)?o(b,c):j(b)};else if(E(R,"getRangeAt")&&typeof R.rangeCount==B)fa=function(b){if(_&&P&&b.docSelection.type==K)p(b);else if(b._ranges.length=b.rangeCount=b.nativeSelection.rangeCount,b.rangeCount){for(var c=0,d=b.rangeCount;d>c;++c)b._ranges[c]=new a.WrappedRange(b.nativeSelection.getRangeAt(c));h(b,b._ranges[b.rangeCount-1],ha(b.nativeSelection)),b.isCollapsed=z(b)}else j(b)};else{if(!U||typeof R.isCollapsed!=A||typeof S.collapsed!=A||!J.implementsDomRange)return b.fail("No means of obtaining a Range or TextRange from the user's selection was found"),!1;fa=function(a){var b,c=a.nativeSelection;c.anchorNode?(b=aa(c,0),a._ranges=[b],a.rangeCount=1,i(a),a.isCollapsed=z(a)):j(a)}}da.refresh=function(a){var b=a?this._ranges.slice(0):null,c=this.anchorNode,d=this.anchorOffset;if(fa(this),a){var e=b.length;if(e!=this._ranges.length)return!0;if(this.anchorNode!=c||this.anchorOffset!=d)return!0;for(;e--;)if(!N(b[e],this._ranges[e]))return!0;return!1}};var ga=function(a,b){var c=a.getAllRanges();a.removeAllRanges();for(var d=0,e=c.length;e>d;++d)N(b,c[d])||a.addRange(c[d]);a.rangeCount||j(a)};_&&P?da.removeRange=function(a){if(this.docSelection.type==K){for(var b,c=this.docSelection.createRange(),d=m(a),e=L(c.item(0)),f=M(e).createControlRange(),g=!1,h=0,i=c.length;i>h;++h)b=c.item(h),b!==d||g?f.add(c.item(h)):g=!0;f.select(),p(this)}else ga(this,a)}:da.removeRange=function(a){ga(this,a)};var ha;!Q&&U&&J.implementsDomRange?(ha=g,da.isBackward=function(){return ha(this)}):ha=da.isBackward=function(){return!1},da.isBackwards=da.isBackward,da.toString=function(){for(var a=[],b=0,c=this.rangeCount;c>b;++b)a[b]=""+this._ranges[b];return a.join("")},da.collapse=function(b,c){v(this,b);var d=a.createRange(b);d.collapseToPoint(b,c),this.setSingleRange(d),this.isCollapsed=!0},da.collapseToStart=function(){if(!this.rangeCount)throw new H("INVALID_STATE_ERR");var a=this._ranges[0];this.collapse(a.startContainer,a.startOffset)},da.collapseToEnd=function(){if(!this.rangeCount)throw new H("INVALID_STATE_ERR");var a=this._ranges[this.rangeCount-1];this.collapse(a.endContainer,a.endOffset)},da.selectAllChildren=function(b){v(this,b);var c=a.createRange(b);c.selectNodeContents(b),this.setSingleRange(c)},da.deleteFromDocument=function(){if(_&&P&&this.docSelection.type==K){for(var a,b=this.docSelection.createRange();b.length;)a=b.item(0),b.remove(a),C.removeNode(a);this.refresh()}else if(this.rangeCount){var c=this.getAllRanges();if(c.length){this.removeAllRanges();for(var d=0,e=c.length;e>d;++d)c[d].deleteContents();this.addRange(c[e-1])}}},da.eachRange=function(a,b){for(var c=0,d=this._ranges.length;d>c;++c)if(a(this.getRangeAt(c)))return b},da.getAllRanges=function(){var a=[];return this.eachRange(function(b){a.push(b)}),a},da.setSingleRange=function(a,b){this.removeAllRanges(),this.addRange(a,b)},da.callMethodOnEachRange=function(a,b){var c=[];return this.eachRange(function(d){c.push(d[a].apply(d,b||[]))}),c},da.setStart=w(!0),da.setEnd=w(!1),a.rangePrototype.select=function(a){ca(this.getDocument()).setSingleRange(this,a)},da.changeEachRange=function(a){var b=[],c=this.isBackward();this.eachRange(function(c){a(c),b.push(c)}),this.removeAllRanges(),c&&1==b.length?this.addRange(b[0],"backward"):this.setRanges(b)},da.containsNode=function(a,b){return this.eachRange(function(c){return c.containsNode(a,b)},!0)||!1},da.getBookmark=function(a){return{backward:this.isBackward(),rangeBookmarks:this.callMethodOnEachRange("getBookmark",[a])}},da.moveToBookmark=function(b){for(var c,d,e=[],f=0;c=b.rangeBookmarks[f++];)d=a.createRange(this.win),d.moveToBookmark(c),e.push(d);b.backward?this.setSingleRange(e[0],"backward"):this.setRanges(e)},da.saveRanges=function(){return{backward:this.isBackward(),ranges:this.callMethodOnEachRange("cloneRange")}},da.restoreRanges=function(a){this.removeAllRanges();for(var b,c=0;b=a.ranges[c];++c)this.addRange(b,a.backward&&0==c)},da.toHtml=function(){var a=[];return this.eachRange(function(b){a.push(F.toHtml(b))}),a.join("")},J.implementsTextRange&&(da.getNativeTextRange=function(){var c;if(c=this.docSelection){var d=c.createRange();if(n(d))return d;throw b.createError("getNativeTextRange: selection is a control selection")}if(this.rangeCount>0)return a.WrappedTextRange.rangeToTextRange(this.getRangeAt(0));throw b.createError("getNativeTextRange: selection contains no range")}),da.getName=function(){return"WrappedSelection"},da.inspect=function(){return x(this)},da.detach=function(){t(this.win,"delete"),s(this)},r.detachAll=function(){t(null,"deleteAll")},r.inspect=x,r.isDirectionBackward=c,a.Selection=r,a.selectionPrototype=da,a.addShimListener(function(a){"undefined"==typeof a.getSelection&&(a.getSelection=function(){return ca(a)}),a=null})});var M=!1,N=function(a){M||(M=!0,!H.initialized&&H.config.autoInitialize&&l())};return F&&("complete"==document.readyState?N():(a(document,"addEventListener")&&document.addEventListener("DOMContentLoaded",N,!1),J(window,"load",N))),H},this);var getRandomValues="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof window.msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto),rng;if(getRandomValues){var rnds8=new Uint8Array(16);rng=function(){return getRandomValues(rnds8),rnds8}}else{var rnds=new Array(16);rng=function(){for(var a,b=0;16>b;b++)0===(3&b)&&(a=4294967296*Math.random()),rnds[b]=a>>>((3&b)<<3)&255;return rnds}}for(var byteToHex=[],i=0;256>i;++i)byteToHex[i]=(i+256).toString(16).substr(1);var _nodeId,_clockseq,_lastMSecs=0,_lastNSecs=0;"function"!=typeof String.prototype.trim&&(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),"indexOf"in Array.prototype||(Array.prototype.indexOf=function(a,b){void 0===b&&(b=0),0>b&&(b+=this.length),0>b&&(b=0);for(var c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1}),"lastIndexOf"in Array.prototype||(Array.prototype.lastIndexOf=function(a,b){for(void 0===b&&(b=this.length-1),0>b&&(b+=this.length),b>this.length-1&&(b=this.length-1),b++;b-->0;)if(b in this&&this[b]===a)return b;return-1}),"map"in Array.prototype||(Array.prototype.map=function(a,b){for(var c=new Array(this.length),d=0,e=this.length;e>d;d++)d in this&&(c[d]=a.call(b,this[d],d,this));return c}),"filter"in Array.prototype||(Array.prototype.filter=function(a,b){for(var c,d=[],e=0,f=this.length;f>e;e++)e in this&&a.call(b,c=this[e],e,this)&&d.push(c);return d}),function(){var a,b,c=this;a={changeIdAttribute:"data-cid",userIdAttribute:"data-userid",userNameAttribute:"data-username",timeAttribute:"data-time",titleDateFormat:"m/d/Y h:ia",attrValuePrefix:"",blockEl:"p",blockEls:["p","ol","ul","li","h1","h2","h3","h4","h5","h6","blockquote"],blockParentsNodeName:["html","body","table","thead","tbody","tfoot"],stylePrefix:"ice-cts",currentUser:{id:null,name:null},changeTypes:{insertType:{tag:"span",alias:"ice-ins",action:"Inserted"},deleteType:{tag:"span",alias:"ice-del",action:"Deleted"}},handleEvents:!1,contentEditable:!0,isTracking:!0,noTrack:".ice-no-track",avoid:".ice-avoid",mergeBlocks:!0,MOUSE_LEFT:0,MOUSE_MIDDLE:1,MOUSE_RIGHT:2},b=function(b){if(this._changes={},b||(b={}),!b.element)throw Error("`options.element` must be defined for ice construction.");ice.dom.extend(!0,this,a,b),this.pluginsManager=new ice.IcePluginManager(this),b.plugins&&this.pluginsManager.usePlugins("ice-init",b.plugins)},b.prototype={_userStyles:{},_styles:{},_uniqueStyleIndex:0,_browserType:null,_batchChangeid:null,_delBookmark:"tempdel",isPlaceHoldingDeletes:!1,startTracking:function(){if(this.element.setAttribute("contentEditable",this.contentEditable),this.handleEvents){var a=this;ice.dom.bind(a.element,"keyup.ice keydown.ice keypress.ice mousedown.ice mouseup.ice",function(b){return a.handleEvent(b)})}return this.initializeEnvironment(),this.initializeEditor(),this.findTrackTags(),this.initializeRange(),this.pluginsManager.fireEnabled(this.element),this},stopTracking:function(){if(this.element.setAttribute("contentEditable",!this.contentEditable),this.handleEvents){var a=this;ice.dom.unbind(a.element,"keyup.ice keydown.ice keypress.ice mousedown.ice mouseup.ice")}return this.pluginsManager.fireDisabled(this.element),this},initializeEnvironment:function(){this.env||(this.env={}),this.env.element=this.element,this.env.document=this.element.ownerDocument,this.env.window=this.env.document.defaultView||this.env.document.parentWindow||window,this.env.frame=this.env.window.frameElement,this.env.selection=this.selection=new ice.Selection(this.env),this.env.document.createElement(this.changeTypes.insertType.tag),this.env.document.createElement(this.changeTypes.deleteType.tag)},initializeRange:function(){var a=this.selection.createRange();a.setStart(ice.dom.find(this.element,this.blockEls.join(", "))[0],0),a.collapse(!0),this.selection.addRange(a),this.env.frame?this.env.frame.contentWindow.focus():this.element.focus()},initializeEditor:function(){var a=this.env.document.createElement("div");this.element.childNodes.length?(a.innerHTML=this.element.innerHTML,ice.dom.removeWhitespace(a),""===a.innerHTML&&a.appendChild(ice.dom.create("<"+this.blockEl+" ><br/></"+this.blockEl+">"))):a.appendChild(ice.dom.create("<"+this.blockEl+" ><br/></"+this.blockEl+">")),this.element.innerHTML!=a.innerHTML&&(this.element.innerHTML=a.innerHTML)},findTrackTags:function(){var a=this,b=[];for(var c in this.changeTypes)b.push(this._getIceNodeClass(c));ice.dom.each(ice.dom.find(this.element,"."+b.join(", .")),function(c,d){for(var e=0,f="",g=d.className.split(" "),c=0;c<g.length;c++){var h=new RegExp(a.stylePrefix+"-(\\d+)").exec(g[c]);h&&(e=h[1]);var i=new RegExp("("+b.join("|")+")").exec(g[c]);i&&(f=a._getChangeTypeFromAlias(i[1]))}var j=ice.dom.attr(d,a.userIdAttribute);a.setUserStyle(j,Number(e));var k=ice.dom.attr(d,a.changeIdAttribute);a._changes[k]={type:f,userid:j,username:ice.dom.attr(d,a.userNameAttribute),time:ice.dom.attr(d,a.timeAttribute)}})},enableChangeTracking:function(){this.isTracking=!0,this.pluginsManager.fireEnabled(this.element)},disableChangeTracking:function(){this.isTracking=!1,this.pluginsManager.fireDisabled(this.element)},setCurrentUser:function(a){this.currentUser=a},handleEvent:function(a){if(this.isTracking){if("mouseup"==a.type){if(0==this._getMouseButton(a)){var b=this;setTimeout(function(){b.mouseUp(a)},200)}return!0}if("mousedown"==a.type)return 0==this._getMouseButton(a)?this.mouseDown(a):!0;if("keypress"==a.type){var c=this.keyPress(a);return c||a.preventDefault(),c}if("keydown"==a.type){var c=this.keyDown(a);return c||a.preventDefault(),c}if("keyup"==a.type)this.pluginsManager.fireCaretUpdated();else{if("paste"==a.type){var c=this.paste(a);return c||a.preventDefault(),c}if("cut"==a.type){var c=this.cut(a);return c||a.preventDefault(),c}}}},visible:function(a){a.nodeType===ice.dom.TEXT_NODE&&(a=a.parentNode);var b=a.getBoundingClientRect();return b.top>0&&b.left>0},createIceNode:function(a,b){var c=this.env.document.createElement(this.changeTypes[a].tag);return ice.dom.addClass(c,this._getIceNodeClass(a)),c.appendChild(b?b:this.env.document.createTextNode("")),this.addChange(this.changeTypes[a].alias,[c]),this.pluginsManager.fireNodeCreated(c,{action:this.changeTypes[a].action}),c},insert:function(a,b){var c=!a;if(a||(a="\ufeff"),b?this.selection.addRange(b):b=this.getCurrentRange(),"string"==typeof a&&(a=document.createTextNode(a)),!b.collapsed&&(this.deleteContents(null,b),b=this.getCurrentRange(),b.startContainer===b.endContainer&&this.element===b.startContainer)){ice.dom.empty(this.element);var d=b.getLastSelectableChild(this.element);b.setStartAfter(d),b.collapse(!0)}this._moveRangeToValidTrackingPos(b);var e=this.startBatchChange();return this._insertNode(a,b,c),this.pluginsManager.fireNodeInserted(a,b),this.endBatchChange(e),c},placeholdDeletes:function(){var a=this;this.isPlaceholdingDeletes&&this.revertDeletePlaceholders(),this.isPlaceholdingDeletes=!0,this._deletes=[];var b="."+this._getIceNodeClass("deleteType");return ice.dom.each(ice.dom.find(this.element,b),function(b,c){a._deletes.push(ice.dom.cloneNode(c)),ice.dom.replaceWith(c,"<"+a._delBookmark+' data-allocation="'+(a._deletes.length-1)+'"/>')}),!0},revertDeletePlaceholders:function(){var a=this;return this.isPlaceholdingDeletes?(ice.dom.each(this._deletes,function(b,c){ice.dom.find(a.element,a._delBookmark+"[data-allocation="+b+"]").replaceWith(c)}),this.isPlaceholdingDeletes=!1,!0):!1},deleteContents:function(a,b){var c=!0,d=ice.dom.browser();b?this.selection.addRange(b):b=this.getCurrentRange();var e=this.startBatchChange(this.changeTypes.deleteType.alias);if(b.collapsed===!1)this._currentUserIceNode(b.startContainer.parentNode)?this._deleteSelection(b):(this._deleteSelection(b),this.visible(b.endContainer)||(b.setEnd(b.endContainer,b.endOffset-1),b.collapse(!1)));else if(a)if("mozilla"===d.type)c=this._deleteRight(b),this.visible(b.endContainer)||(b.endContainer.parentNode.nextSibling?b.setEndBefore(b.endContainer.parentNode.nextSibling):b.setEndAfter(b.endContainer),b.collapse(!1));else{if(b.endOffset===ice.dom.getNodeCharacterLength(b.endContainer)){var f=b.startContainer.nextSibling;if(ice.dom.is(f,"."+this._getIceNodeClass("deleteType")))for(;f;){if(!ice.dom.is(f,"."+this._getIceNodeClass("deleteType"))){b.setStart(f,0),b.collapse(!0);break}f=f.nextSibling}}c=this._deleteRight(b),this.visible(b.endContainer)||ice.dom.is(b.endContainer.parentNode,"."+this._getIceNodeClass("insertType")+", ."+this._getIceNodeClass("deleteType"))&&(b.setStartAfter(b.endContainer.parentNode),b.collapse(!0))}else if("mozilla"===d.type)c=this._deleteLeft(b),this.visible(b.startContainer)||(b.startContainer.parentNode.previousSibling?b.setEnd(b.startContainer.parentNode.previousSibling,0):b.setEnd(b.startContainer.parentNode,0),b.moveEnd(ice.dom.CHARACTER_UNIT,ice.dom.getNodeCharacterLength(b.endContainer)),b.collapse(!1));else{if(!this.visible(b.startContainer)&&b.endOffset===ice.dom.getNodeCharacterLength(b.endContainer)){var g=b.startContainer.previousSibling;if(ice.dom.is(g,"."+this._getIceNodeClass("deleteType")))for(;g;){if(!ice.dom.is(g,"."+this._getIceNodeClass("deleteType"))){b.setEndBefore(g.nextSibling,0),b.collapse(!1);break}g=g.prevSibling}}c=this._deleteLeft(b)}this.selection.addRange(b),this.endBatchChange(e);var h=document.createEvent("Event");return h.initEvent("ice:deleteContents",!0,!0),this.element.dispatchEvent(h),c},getChanges:function(){return this._changes},getChangeUserids:function(){var a=[],b=Object.keys(this._changes);for(var c in b)a.push(this._changes[b[c]].userid);return a.sort().filter(function(a,b,c){return b==c.indexOf(a)?1:0})},getElementContent:function(){return this.element.innerHTML},getCleanContent:function(a,b,c){var d="",e=this;ice.dom.each(this.changeTypes,function(a,b){"deleteType"!=a&&(b>0&&(d+=","),d+="."+e._getIceNodeClass(a))}),a=a?"string"==typeof a?ice.dom.create("<div>"+a+"</div>"):ice.dom.cloneNode(a,!1)[0]:ice.dom.cloneNode(this.element,!1)[0],a=c?c.call(this,a):a;var f=ice.dom.find(a,d);ice.dom.each(f,function(a,b){ice.dom.replaceWith(this,ice.dom.contents(this))});var g=ice.dom.find(a,"."+this._getIceNodeClass("deleteType"));return ice.dom.remove(g),a=b?b.call(this,a):a,a.innerHTML},acceptAll:function(){this.element.innerHTML=this.getCleanContent()},rejectAll:function(){var a="."+this._getIceNodeClass("insertType"),b="."+this._getIceNodeClass("deleteType");ice.dom.remove(ice.dom.find(this.element,a)),ice.dom.each(ice.dom.find(this.element,b),function(a,b){ice.dom.replaceWith(b,ice.dom.contents(b))})},acceptChange:function(a){this.acceptRejectChange(a,!0)},rejectChange:function(a){this.acceptRejectChange(a,!1)},acceptRejectChange:function(a,b){var c,d,e,f,g,h,i,j=ice.dom,k=(a.parentElement,[]),l=this;if(!a){var m=this.getCurrentRange();if(!m.collapsed)return;a=m.startContainer}c=f="."+this._getIceNodeClass("deleteType"),d=g="."+this._getIceNodeClass("insertType"),e=c+","+d,h=j.getNode(a,e),i=j.find(this.element,"["+this.changeIdAttribute+"="+j.attr(h,this.changeIdAttribute)+"]"),$.each(i,function(a,b){for(var c=b.parentElement;c&&-1===l.blockParentsNodeName.indexOf(c.nodeName.toLowerCase());)k[k.length]=c,c=c.parentElement}),b||(f=d,g=c),ice.dom.is(h,g)?j.each(i,function(a,b){j.replaceWith(b,ice.dom.contents(b))}):j.is(h,f)&&(j.remove(i),b&&$.each(k,function(a,b){return $(b).children("br[data-mce-bogus]").remove(),j.hasNoTextOrStubContent(b)?void j.remove(b):!1}))},isInsideChange:function(a){var b="."+this._getIceNodeClass("insertType")+", ."+this._getIceNodeClass("deleteType");if(!a){if(range=this.getCurrentRange(),!range.collapsed)return!1;a=range.startContainer}return!!ice.dom.getNode(a,b)},addChangeType:function(a,b,c,d){var e={tag:b,alias:c};d&&(e.action=d),this.changeTypes[a]=e},getIceNode:function(a,b){var c="."+this._getIceNodeClass(b);return ice.dom.getNode(a,c)},_moveRangeToValidTrackingPos:function(a){for(var b=!1,c=this._getVoidElement(a.endContainer);c;){try{a.moveEnd(ice.dom.CHARACTER_UNIT,1),a.moveEnd(ice.dom.CHARACTER_UNIT,-1)}catch(d){b=!0}if(b||ice.dom.onBlockBoundary(a.endContainer,a.startContainer,this.blockEls)){a.setStartAfter(c),a.collapse(!0);break}c=this._getVoidElement(a.endContainer),c?(a.setEnd(a.endContainer,0),a.moveEnd(ice.dom.CHARACTER_UNIT,ice.dom.getNodeCharacterLength(a.endContainer)),a.collapse()):(a.setStart(a.endContainer,0),a.collapse(!0))}},_getNoTrackElement:function(a){var b=this._getNoTrackSelector(),c=ice.dom.is(a,b)?a:ice.dom.parents(a,b)[0]||null;return c},_getNoTrackSelector:function(){return this.noTrack},_getVoidElement:function(a){var b=this._getVoidElSelector();return ice.dom.is(a,b)?a:ice.dom.parents(a,b)[0]||null},_getVoidElSelector:function(){return"."+this._getIceNodeClass("deleteType")+","+this.avoid},_currentUserIceNode:function(a){return ice.dom.attr(a,this.userIdAttribute)==this.currentUser.id},_getChangeTypeFromAlias:function(a){var b,c=null;for(b in this.changeTypes)this.changeTypes.hasOwnProperty(b)&&this.changeTypes[b].alias==a&&(c=b);return c},_getIceNodeClass:function(a){return this.attrValuePrefix+this.changeTypes[a].alias},getUserStyle:function(a){var b=null;return b=this._userStyles[a]?this._userStyles[a]:this.setUserStyle(a,this.getNewStyleId())},setUserStyle:function(a,b){var c=this.stylePrefix+"-"+b;return this._styles[b]||(this._styles[b]=!0),this._userStyles[a]=c},getNewStyleId:function(){var a=++this._uniqueStyleIndex;return this._styles[a]?this.getNewStyleId():(this._styles[a]=!0,a)},addChange:function(a,b){var c=this._batchChangeid||this.getNewChangeId();this._changes[c]||(this._changes[c]={type:this._getChangeTypeFromAlias(a),time:(new Date).getTime(),userid:this.currentUser.id,username:this.currentUser.name});var d=this;return ice.dom.foreach(b,function(a){d.addNodeToChange(c,b[a])}),c},addNodeToChange:function(a,b){null!==this._batchChangeid&&(a=this._batchChangeid);var c=this.getChange(a);b.getAttribute(this.changeIdAttribute)||b.setAttribute(this.changeIdAttribute,a),b.getAttribute(this.userIdAttribute)||b.setAttribute(this.userIdAttribute,c.userid),b.getAttribute(this.userNameAttribute)||b.setAttribute(this.userNameAttribute,c.username),b.getAttribute(this.timeAttribute)||b.setAttribute(this.timeAttribute,c.time),ice.dom.hasClass(b,this._getIceNodeClass(c.type))||ice.dom.addClass(b,this._getIceNodeClass(c.type));var d=this.getUserStyle(c.userid);ice.dom.hasClass(b,d)||ice.dom.addClass(b,d)},getChange:function(a){var b=null;return this._changes[a]&&(b=this._changes[a]),b},getNewChangeId:function(){var a=uuidv1();return this._changes[a]&&(a=this.getNewChangeId()),a},startBatchChange:function(){return this._batchChangeid=this.getNewChangeId(),this._batchChangeid},endBatchChange:function(a){a===this._batchChangeid&&(this._batchChangeid=null)},getCurrentRange:function(){return this.selection.getRangeAt(0)},_insertNode:function(a,b,c){ice.dom.isBlockElement(b.startContainer)||ice.dom.canContainTextElement(ice.dom.getBlockParent(b.startContainer,this.element))||!b.startContainer.previousSibling||b.setStart(b.startContainer.previousSibling,0);var d=(b.startContainer,ice.dom.isBlockElement(b.startContainer)&&b.startContainer||ice.dom.getBlockParent(b.startContainer,this.element)||null);if(d===this.element){var e=document.createElement(this.blockEl);return d.appendChild(e),b.setStart(e,0),b.collapse(),this._insertNode(a,b,c)}ice.dom.hasNoTextOrStubContent(d)&&(ice.dom.empty(d),
ice.dom.append(d,"<br>"),b.setStart(d,0));var f=this.getIceNode(b.startContainer,"insertType"),g=this._currentUserIceNode(f);c&&g||(g||(a=this.createIceNode("insertType",a)),b.insertNode(a),b.setEnd(a,1),c?b.setStart(a,0):b.collapse(),this.selection.addRange(b))},_handleVoidEl:function(a,b){var c=this._getVoidElement(a);return c&&!this.getIceNode(c,"deleteType")?(b.collapse(!0),!0):!1},_deleteSelection:function(a){for(var b=new ice.Bookmark(this.env,a),c=ice.dom.getElementsBetween(b.start,b.end),d=ice.dom.parents(a.startContainer,this.blockEls.join(", "))[0],e=ice.dom.parents(a.endContainer,this.blockEls.join(", "))[0],f=new Array,g=0;g<c.length;g++){var h=c[g];if(!ice.dom.isBlockElement(h)||(f.push(h),ice.dom.canContainTextElement(h))){if((h.nodeType!==ice.dom.TEXT_NODE||0!==ice.dom.getNodeTextContent(h).length)&&!this._getVoidElement(h)){if(h.nodeType!==ice.dom.TEXT_NODE){if(ice.dom.BREAK_ELEMENT==ice.dom.getTagName(h))continue;if(ice.dom.isStubElement(h)){this._addNodeTracking(h,!1,!0);continue}for(ice.dom.hasNoTextOrStubContent(h)&&ice.dom.remove(h),j=0;j<h.childNodes.length;j++){var i=h.childNodes[j];c.push(i)}continue}var k=ice.dom.getBlockParent(h);this._addNodeTracking(h,!1,!0,!0),ice.dom.hasNoTextOrStubContent(k)&&ice.dom.remove(k)}}else for(var l=0;l<h.childNodes.length;l++)c.push(h.childNodes[l])}if(this.mergeBlocks&&d!==e){for(;f.length;)ice.dom.mergeContainers(f.shift(),d);ice.dom.removeBRFromChild(e),ice.dom.removeBRFromChild(d),ice.dom.mergeContainers(e,d)}b.selectBookmark(),a.collapse(!0)},_deleteRight:function(a){var b,c,d=ice.dom.isBlockElement(a.startContainer)&&a.startContainer||ice.dom.getBlockParent(a.startContainer,this.element)||null,e=d?ice.dom.hasNoTextOrStubContent(d):!1,f=d&&ice.dom.getNextContentNode(d,this.element),g=f?ice.dom.hasNoTextOrStubContent(f):!1,h=a.endContainer,i=a.endOffset,j=a.commonAncestorContainer;if(e)return!1;if(j.nodeType!==ice.dom.TEXT_NODE){if(0===i&&ice.dom.isBlockElement(j)&&!ice.dom.canContainTextElement(j)){var k=j.firstElementChild;if(k)return a.setStart(k,0),a.collapse(),this._deleteRight(a)}if(j.childNodes.length>i){var l=document.createTextNode(" ");return j.insertBefore(l,j.childNodes[i]),a.setStart(l,1),a.collapse(!0),c=this._deleteRight(a),ice.dom.remove(l),c}return b=ice.dom.getNextContentNode(j,this.element),a.setEnd(b,0),a.collapse(),this._deleteRight(a)}if(a.moveEnd(ice.dom.CHARACTER_UNIT,1),a.moveEnd(ice.dom.CHARACTER_UNIT,-1),i===h.data.length&&!ice.dom.hasNoTextOrStubContent(h)){if(b=ice.dom.getNextNode(h,this.element),!b)return a.selectNodeContents(h),a.collapse(),!1;if(ice.dom.BREAK_ELEMENT==ice.dom.getTagName(b)&&(b=ice.dom.getNextNode(b,this.element)),b.nodeType===ice.dom.TEXT_NODE&&(b=b.parentNode),!b.isContentEditable){c=this._addNodeTracking(b,!1,!1);var m=document.createTextNode("");return b.parentNode.insertBefore(m,b.nextSibling),a.selectNode(m),a.collapse(!0),c}if(this._handleVoidEl(b,a))return!0;if(ice.dom.isChildOf(b,d)&&ice.dom.isStubElement(b))return this._addNodeTracking(b,a,!1)}if(this._handleVoidEl(b,a))return!0;if(this._getNoTrackElement(a.endContainer.parentElement))return a.deleteContents(),!1;if(ice.dom.isOnBlockBoundary(a.startContainer,a.endContainer,this.element)){if(this.mergeBlocks&&ice.dom.is(ice.dom.getBlockParent(b,this.element),this.blockEl)){f!==ice.dom.getBlockParent(a.endContainer,this.element)&&a.setEnd(f,0);for(var n=ice.dom.getElementsBetween(a.startContainer,a.endContainer),o=0;o<n.length;o++)ice.dom.remove(n[o]);var p=a.startContainer,q=a.endContainer;return ice.dom.remove(ice.dom.find(p,"br")),ice.dom.remove(ice.dom.find(q,"br")),ice.dom.mergeBlockWithSibling(a,ice.dom.getBlockParent(a.endContainer,this.element)||d)}return g?(ice.dom.remove(f),a.collapse(!0),!0):(a.setStart(f,0),a.collapse(!0),!0)}var r=a.endContainer,s=r.splitText(a.endOffset);s.splitText(1);return this._addNodeTracking(s,a,!1)},_deleteLeft:function(a){var b,c,d=ice.dom.isBlockElement(a.startContainer)&&a.startContainer||ice.dom.getBlockParent(a.startContainer,this.element)||null,e=d?ice.dom.hasNoTextOrStubContent(d):!1,f=d&&ice.dom.getPrevContentNode(d,this.element),g=f?ice.dom.hasNoTextOrStubContent(f):!1,h=a.startContainer,i=a.startOffset,j=a.commonAncestorContainer;if(e)return!1;if(0===i||j.nodeType!==ice.dom.TEXT_NODE){if(ice.dom.isBlockElement(j)&&!ice.dom.canContainTextElement(j))if(0===i){var k=j.firstElementChild;if(k)return a.setStart(k,0),a.collapse(),this._deleteLeft(a)}else{var l=j.lastElementChild;if(l&&(b=a.getLastSelectableChild(l)))return a.setStart(b,b.data.length),a.collapse(),this._deleteLeft(a)}if(0===i)c=ice.dom.getPrevContentNode(h,this.element);else{c=j.childNodes[i-1]}if(!c)return!1;if(ice.dom.is(c,"."+this._getIceNodeClass("insertType")+", ."+this._getIceNodeClass("deleteType"))&&c.childNodes.length>0&&c.lastChild&&(c=c.lastChild),c.nodeType===ice.dom.TEXT_NODE&&(c=c.parentNode),!c.isContentEditable){var m=this._addNodeTracking(c,!1,!0),n=document.createTextNode("");return c.parentNode.insertBefore(n,c),a.selectNode(n),a.collapse(!0),m}if(this._handleVoidEl(c,a))return!0;if(ice.dom.isStubElement(c)&&ice.dom.isChildOf(c,d)||!c.isContentEditable)return this._addNodeTracking(c,a,!0);if(ice.dom.isStubElement(c))return ice.dom.remove(c),a.collapse(!0),!1;if(c!==d&&!ice.dom.isChildOf(c,d)){if(ice.dom.canContainTextElement(c)||(c=c.lastElementChild),c.lastChild&&c.lastChild.nodeType!==ice.dom.TEXT_NODE&&ice.dom.isStubElement(c.lastChild)&&"BR"!==c.lastChild.tagName)return a.setStartAfter(c.lastChild),a.collapse(!0),!0;if(b=a.getLastSelectableChild(c),b&&!ice.dom.isOnBlockBoundary(a.startContainer,b,this.element))return a.selectNodeContents(b),a.collapse(),!0}}if(1===i&&!ice.dom.isBlockElement(j)&&a.startContainer.childNodes.length>1&&a.startContainer.childNodes[0].nodeType===ice.dom.TEXT_NODE&&0===a.startContainer.childNodes[0].data.length)return a.setStart(a.startContainer,0),this._deleteLeft(a);if(a.moveStart(ice.dom.CHARACTER_UNIT,-1),a.moveStart(ice.dom.CHARACTER_UNIT,1),this._getNoTrackElement(a.startContainer.parentElement))return a.deleteContents(),!1;if(ice.dom.isOnBlockBoundary(a.startContainer,a.endContainer,this.element)){if(g)return ice.dom.remove(f),a.collapse(),!0;if(this.mergeBlocks&&ice.dom.is(ice.dom.getBlockParent(c,this.element),this.blockEl)){f!==ice.dom.getBlockParent(a.startContainer,this.element)&&a.setStart(f,f.childNodes.length);for(var o=ice.dom.getElementsBetween(a.startContainer,a.endContainer),p=0;p<o.length;p++)ice.dom.remove(o[p]);var q=a.startContainer,r=a.endContainer;return ice.dom.remove(ice.dom.find(q,"br")),ice.dom.remove(ice.dom.find(r,"br")),ice.dom.mergeBlockWithSibling(a,ice.dom.getBlockParent(a.endContainer,this.element)||d)}return f&&f.lastChild&&ice.dom.isStubElement(f.lastChild)?(a.setStartAfter(f.lastChild),a.collapse(!0),!0):(b=a.getLastSelectableChild(f),b?(a.setStart(b,b.data.length),a.collapse(!0)):f&&(a.setStart(f,f.childNodes.length),a.collapse(!0)),!0)}var s=a.startContainer,t=s.splitText(a.startOffset-1);t.splitText(1);return this._addNodeTracking(t,a,!0)},_addNodeTracking:function(a,b,c){var d=this.getIceNode(a,"insertType");if(d&&this._currentUserIceNode(d)){b&&c&&b.selectNode(a),a.parentNode.removeChild(a);var e=ice.dom.cloneNode(d);if(ice.dom.remove(ice.dom.find(e,".iceBookmark")),null!==d&&ice.dom.hasNoTextOrStubContent(e[0])){var f=this.env.document.createTextNode("");ice.dom.insertBefore(d,f),b&&(b.setStart(f,0),b.collapse(!0)),ice.dom.replaceWith(d,ice.dom.contents(d))}return!0}if(b&&this.getIceNode(a,"deleteType")){a.normalize();var g=!1;if(c){for(var h=ice.dom.getPrevContentNode(a,this.element);!g;)k=this.getIceNode(h,"deleteType"),k?h=ice.dom.getPrevContentNode(h,this.element):g=!0;if(h){var i=b.getLastSelectableChild(h);i&&(h=i),b.setStart(h,ice.dom.getNodeCharacterLength(h)),b.collapse(!0)}return!0}for(var j=ice.dom.getNextContentNode(a,this.element);!g;)k=this.getIceNode(j,"deleteType"),k?j=ice.dom.getNextContentNode(j,this.element):g=!0;return j&&(b.selectNodeContents(j),b.collapse(!0)),!0}a.previousSibling&&a.previousSibling.nodeType===ice.dom.TEXT_NODE&&0===a.previousSibling.length&&a.parentNode.removeChild(a.previousSibling),a.nextSibling&&a.nextSibling.nodeType===ice.dom.TEXT_NODE&&0===a.nextSibling.length&&a.parentNode.removeChild(a.nextSibling);var k,l=this.getIceNode(a.previousSibling,"deleteType"),m=this.getIceNode(a.nextSibling,"deleteType");if(l&&this._currentUserIceNode(l)){if(k=l,k.appendChild(a),m&&this._currentUserIceNode(m)){var n=ice.dom.extractContent(m);ice.dom.append(k,n),m.parentNode.removeChild(m)}}else m&&this._currentUserIceNode(m)?(k=m,k.insertBefore(a,k.firstChild)):(k=this.createIceNode("deleteType"),a.parentNode.insertBefore(k,a),k.appendChild(a));return b&&(ice.dom.isStubElement(a)?b.selectNode(a):b.selectNodeContents(a),c?b.collapse(!0):b.collapse(),a.normalize()),!0},_handleAncillaryKey:function(a){var b=a.keyCode?a.keyCode:a.which,c=ice.dom.browser(),d=!0,e=a.shiftKey,f=this,g=f.getCurrentRange();switch(b){case ice.dom.DOM_VK_BACK_SPACE:d=this.deleteContents(),this.pluginsManager.fireKeyPressed(a);break;case ice.dom.DOM_VK_DELETE:e&&this._sendToClipboard(g),d=this.deleteContents(!0),this.pluginsManager.fireKeyPressed(a);break;case ice.dom.DOM_VK_DOWN:case ice.dom.DOM_VK_UP:case ice.dom.DOM_VK_LEFT:this.pluginsManager.fireCaretPositioned(),"mozilla"===c.type&&(this.visible(g.startContainer)||(g.startContainer.parentNode.previousSibling?(g.setEnd(g.startContainer.parentNode.previousSibling,0),g.moveEnd(ice.dom.CHARACTER_UNIT,ice.dom.getNodeCharacterLength(g.endContainer)),g.collapse(!1)):(g.setEnd(g.startContainer.parentNode.nextSibling,0),g.collapse(!1)))),d=!1;break;case ice.dom.DOM_VK_RIGHT:this.pluginsManager.fireCaretPositioned(),"mozilla"===c.type&&(this.visible(g.startContainer)||g.startContainer.parentNode.nextSibling&&(g.setStart(g.startContainer.parentNode.nextSibling,0),g.collapse(!0))),d=!1;break;case ice.dom.DOM_VK_SPACE:d=!0;var g=this.getCurrentRange();this._moveRangeToValidTrackingPos(g,g.startContainer),this.insert("\xa0",g);break;default:d=!1}return d===!0?(ice.dom.preventDefault(a),!1):!0},keyDown:function(a){if(!this.pluginsManager.fireKeyDown(a))return ice.dom.preventDefault(a),!1;var b=!1;if(this._handleSpecialKey(a)===!1)return ice.dom.isBrowser("msie")!==!0&&(this._preventKeyPress=!0),!1;if(!(a.ctrlKey!==!0&&a.metaKey!==!0||ice.dom.isBrowser("msie")!==!0&&ice.dom.isBrowser("chrome")!==!0||this.pluginsManager.fireKeyPressed(a)))return!1;switch(a.keyCode){case ice.dom.DOM_VK_ESCAPE:break;default:b=!this._handleAncillaryKey(a)}return b?(ice.dom.preventDefault(a),!1):!0},keyPress:function(a){if(this._preventKeyPress===!0)return void(this._preventKeyPress=!1);if(!this.pluginsManager.fireKeyPress(a))return!1;var b=null;null==a.which?b=String.fromCharCode(a.keyCode):a.which>0&&(b=String.fromCharCode(a.which));var c=this.getCurrentRange(),d=ice.dom.parents(c.startContainer,"br")[0]||null;if(d&&(c.moveToNextEl(d),d.parentNode.removeChild(d)),null!==b&&a.ctrlKey!==!0&&a.metaKey!==!0){var e=a.keyCode?a.keyCode:a.which;switch(e){case ice.dom.DOM_VK_BACK_SPACE:return this._handleAncillaryKey(a);case ice.dom.DOM_VK_RETURN:return this._handleEnter();case ice.dom.DOM_VK_SPACE:return this._handleAncillaryKey(a);default:return this._moveRangeToValidTrackingPos(c,c.startContainer),this.insert(a.key)}}return this._handleAncillaryKey(a)},paste:function(a){var b=this.pluginsManager.plugins.IceCopyPastePlugin;return b.handlePaste(a)?(jQuery(b._pasteElement).trigger("paste"),!0):(ice.dom.preventDefault(a),!1)},cut:function(a){var b=this.pluginsManager.plugins.IceCopyPastePlugin;return b.handleCut(a)?!0:(ice.dom.preventDefault(a),!1)},mouseUp:function(a,b){return this.pluginsManager.fireClicked(a)?void this.pluginsManager.fireSelectionChanged(this.getCurrentRange()):!1},mouseDown:function(a,b){return this.pluginsManager.fireMouseDown(a)?void this.pluginsManager.fireCaretUpdated():!1},_handleEnter:function(){var a=this.getCurrentRange();return a.collapsed||this.deleteContents(),!0},_handleSpecialKey:function(a){var b=a.which;null===b&&(b=a.keyCode);var c=!1;switch(b){case ice.dom.DOM_VK_A:if(a.ctrlKey===!0||a.metaKey===!0){c=!0;var d=this.getCurrentRange();if(ice.dom.isBrowser("msie")===!0){var e=this.env.document.createTextNode(""),f=this.env.document.createTextNode("");this.element.firstChild?ice.dom.insertBefore(this.element.firstChild,e):this.element.appendChild(e),this.element.appendChild(f),d.setStart(e,0),d.setEnd(f,0)}else{d.setStart(d.getFirstSelectableChild(this.element),0);var g=d.getLastSelectableChild(this.element);d.setEnd(g,g.length)}this.selection.addRange(d)}}return c===!0?(ice.dom.preventDefault(a),!1):!0},_getMouseButton:function(a){if("which"in a)switch(a.which){case 3:return this.MOUSE_RIGHT;case 2:return this.MOUSE_MIDDLE;default:return this.MOUSE_LEFT}else if("button"in a)switch(a.button){case 2:return this.MOUSE_RIGHT;case 1:return this.MOUSE_MIDDLE;default:return this.MOUSE_LEFT}return this.MOUSE_LEFT},_sendToClipboard:function(a){navigator.clipboard?navigator.clipboard.writeText(a.toString()):document.execCommand("copy")}},c.ice=this.ice||{},c.ice.InlineChangeEditor=b}.call(this),function(){var a=this,b=null,c={};c.DOM_VK_BACK_SPACE=8,c.DOM_VK_TAB=9,c.DOM_VK_RETURN=13,c.DOM_VK_ESCAPE=27,c.DOM_VK_SPACE=32,c.DOM_VK_LEFT=37,c.DOM_VK_UP=38,c.DOM_VK_RIGHT=39,c.DOM_VK_DOWN=40,c.DOM_VK_DELETE=46,c.DOM_VK_A=65,c.DOM_VK_V=86,c.DOM_VK_X=88,c.DOM_VK_HYPHEN_MINUS=173,c.DOM_VK_DASH=189,c.DOM_VK_PERIOD=190,c.ELEMENT_NODE=1,c.ATTRIBUTE_NODE=2,c.TEXT_NODE=3,c.CDATA_SECTION_NODE=4,c.ENTITY_REFERENCE_NODE=5,c.ENTITY_NODE=6,c.PROCESSING_INSTRUCTION_NODE=7,c.COMMENT_NODE=8,c.DOCUMENT_NODE=9,c.DOCUMENT_TYPE_NODE=10,c.DOCUMENT_FRAGMENT_NODE=11,c.NOTATION_NODE=12,c.CHARACTER_UNIT="character",c.WORD_UNIT="word",c.BREAK_ELEMENT="br",c.CONTENT_STUB_ELEMENTS=["img","hr","br","iframe","param","link","meta","input","frame","col","base","area"],c.BLOCK_ELEMENTS=["p","div","pre","ul","ol","li","table","tbody","td","th","fieldset","form","blockquote","dl","dt","dd","dir","center","address","h1","h2","h3","h4","h5","h6"],c.TEXT_CONTAINER_ELEMENTS=["p","div","pre","li","td","th","blockquote","dt","dd","center","address","h1","h2","h3","h4","h5","h6"],c.STUB_ELEMENTS=c.CONTENT_STUB_ELEMENTS.slice(),c.STUB_ELEMENTS.push(c.BREAK_ELEMENT),c.getKeyChar=function(a){return String.fromCharCode(a.which)},c.getClass=function(a,b,c){return b||(b=document.body),a="."+a.split(" ").join("."),c&&(a=c+a),jQuery.makeArray(jQuery(b).find(a))},c.getId=function(a,b){return b||(b=document),element=b.getElementById(a),element},c.getTag=function(a,b){return b||(b=document),jQuery.makeArray(jQuery(b).find(a))},c.getElementWidth=function(a){return a.offsetWidth},c.getElementHeight=function(a){return a.offsetHeight},c.getElementDimensions=function(a){var b={width:c.getElementWidth(a),height:c.getElementHeight(a)};return b},c.trim=function(a){return jQuery.trim(a)},c.empty=function(a){return a?jQuery(a).empty():void 0},c.remove=function(a){return a?jQuery(a).remove():void 0},c.prepend=function(a,b){jQuery(a).prepend(b)},c.append=function(a,b){jQuery(a).append(b)},c.insertBefore=function(a,b){jQuery(a).before(b)},c.insertAfter=function(a,b){jQuery(a).after(b)},c.getHtml=function(a){return jQuery(a).html()},c.setHtml=function(a,b){a&&jQuery(a).html(b)},c.removeWhitespace=function(a){jQuery(a).contents().filter(function(){return this.nodeType!=ice.dom.TEXT_NODE&&"UL"==this.nodeName||"OL"==this.nodeName?(c.removeWhitespace(this),!1):this.nodeType!=ice.dom.TEXT_NODE?!1:!/\S/.test(this.nodeValue)}).remove()},c.contents=function(a){return jQuery.makeArray(jQuery(a).contents())},c.extractContent=function(a){for(var b,c=document.createDocumentFragment();b=a.firstChild;)c.appendChild(b);return c},c.getNode=function(a,b){return c.is(a,b)?a:c.parents(a,b)[0]||null},c.getParents=function(a,b,c){for(var d=jQuery(a).parents(b),e=d.length,f=[],g=0;e>g&&d[g]!==c;g++)f.push(d[g]);return f},c.hasBlockChildren=function(a){for(var b=a.childNodes.length,d=0;b>d;d++)if(a.childNodes[d].nodeType===c.ELEMENT_NODE&&c.isBlockElement(a.childNodes[d])===!0)return!0;return!1},c.removeTag=function(a,b){return jQuery(a).find(b).replaceWith(function(){return jQuery(this).contents()}),a},c.stripEnclosingTags=function(a,b){var c=jQuery(a);return c.find("*").not(b).replaceWith(function(){var a,b=jQuery();try{a=jQuery(this),b=a.contents()}catch(c){}return 0===b.length&&a.remove(),b}),c[0]},c.getSiblings=function(a,b,c,d){if(c===!0)return"prev"===b?jQuery(a).prevAll():jQuery(a).nextAll();var e=[];if("prev"===b)for(;a.previousSibling&&(a=a.previousSibling,a!==d);)e.push(a);else for(;a.nextSibling&&(a=a.nextSibling,a!==d);)e.push(a);return e},c.getNodeTextContent=function(a){return jQuery(a).text()},c.getNodeStubContent=function(a){return jQuery(a).find(c.CONTENT_STUB_ELEMENTS.join(", "))},c.hasNoTextOrStubContent=function(a){return c.getNodeTextContent(a).length>0?!1:jQuery(a).find(c.CONTENT_STUB_ELEMENTS.join(", ")).length>0?!1:!0},c.getNodeCharacterLength=function(a){return c.getNodeTextContent(a).length+jQuery(a).find(c.STUB_ELEMENTS.join(", ")).length},c.setNodeTextContent=function(a,b){return jQuery(a).text(b)},c.getTagName=function(a){return a.tagName&&a.tagName.toLowerCase()||null},c.getIframeDocument=function(a){var b=null;return a.contentDocument?b=a.contentDocument:a.contentWindow?b=a.contentWindow.document:a.document&&(b=a.document),b},c.isBlockElement=function(a){return-1!=c.BLOCK_ELEMENTS.lastIndexOf(a.nodeName.toLowerCase())},c.isStubElement=function(a){return-1!=c.STUB_ELEMENTS.lastIndexOf(a.nodeName.toLowerCase())},c.removeBRFromChild=function(a){if(a&&a.hasChildNodes())for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];c&&ice.dom.BREAK_ELEMENT==ice.dom.getTagName(c)&&c.parentNode.removeChild(c)}},c.isChildOf=function(a,b){try{for(;a&&a.parentNode;){if(a.parentNode===b)return!0;a=a.parentNode}}catch(c){}return!1},c.isChildOfTagName=function(a,b){try{for(;a&&a.parentNode;){if(a.parentNode&&a.parentNode.tagName&&a.parentNode.tagName.toLowerCase()===b)return a.parentNode;a=a.parentNode}}catch(c){}return!1},c.isChildOfTagNames=function(a,b){try{for(;a&&a.parentNode;){if(a.parentNode&&a.parentNode.tagName){tagName=a.parentNode.tagName.toLowerCase();for(var c=0;c<b.length;c++)if(tagName===b[c])return a.parentNode}a=a.parentNode}}catch(d){}return null},c.isChildOfClassName=function(a,b){try{for(;a&&a.parentNode;){if(jQuery(a.parentNode).hasClass(b))return a.parentNode;a=a.parentNode}}catch(c){}return null},c.cloneNode=function(a,b){return void 0===b&&(b=!0),jQuery(a).clone(b)},c.bind=function(a,b,c){return jQuery(a).bind(b,c)},c.unbind=function(a,b,c){return jQuery(a).unbind(b,c)},c.attr=function(a,b,c){return c?jQuery(a).attr(b,c):jQuery(a).attr(b)},c.replaceWith=function(a,b){return jQuery(a).replaceWith(b)},c.removeAttr=function(a,b){jQuery(a).removeAttr(b)},c.getElementsBetween=function(a,b){var d=[];if(a===b)return d;if(c.isChildOf(b,a)===!0){for(var e=a.childNodes.length,f=0;e>f&&a.childNodes[f]!==b;f++){if(c.isChildOf(b,a.childNodes[f])===!0)return c.arrayMerge(d,c.getElementsBetween(a.childNodes[f],b));d.push(a.childNodes[f])}return d}for(var g=a.nextSibling;g;){if(c.isChildOf(b,g)===!0)return d=c.arrayMerge(d,c.getElementsBetween(g,b));if(g===b)return d;d.push(g),g=g.nextSibling}for(var h=c.getParents(a),i=c.getParents(b),j=c.arrayDiff(h,i,!0),k=j.length,l=0;k-1>l;l++)d=c.arrayMerge(d,c.getSiblings(j[l],"next"));var m=j[j.length-1];return d=c.arrayMerge(d,c.getElementsBetween(m,b))},c.getCommonAncestor=function(a,b){for(var d=a;d;){if(c.isChildOf(b,d)===!0)return d;d=d.parentNode}return null},c.getNextNode=function(a,b){if(a)for(;a.parentNode;){if(a===b)return null;if(a.nextSibling){if(a.nextSibling.nodeType===c.TEXT_NODE&&0===a.nextSibling.length){a=a.nextSibling;continue}return c.getFirstChild(a.nextSibling)}a=a.parentNode}return null},c.getNextContentNode=function(a,b){if(a)for(;a.parentNode;){if(a===b)return null;if(a.nextSibling&&c.canContainTextElement(c.getBlockParent(a))){if(a.nextSibling.nodeType===c.TEXT_NODE&&0===a.nextSibling.length){a=a.nextSibling;continue}return a.nextSibling}if(a.nextElementSibling)return a.nextElementSibling;a=a.parentNode}return null},c.getPrevNode=function(a,b){if(a)for(;a.parentNode;){if(a===b)return null;if(a.previousSibling){if(a.previousSibling.nodeType===c.TEXT_NODE&&0===a.previousSibling.length){a=a.previousSibling;continue}return c.getLastChild(a.previousSibling)}a=a.parentNode}return null},c.getPrevContentNode=function(a,b){if(a)for(;a.parentNode;){if(a===b)return null;if(a.previousSibling&&c.canContainTextElement(c.getBlockParent(a))){if(a.previousSibling.nodeType===c.TEXT_NODE&&0===a.previousSibling.length){a=a.previousSibling;continue}return a.previousSibling}if(a.previousElementSibling)return a.previousElementSibling;a=a.parentNode}return null},c.canContainTextElement=function(a){return a&&a.nodeName?-1!=c.TEXT_CONTAINER_ELEMENTS.lastIndexOf(a.nodeName.toLowerCase()):!1},c.getFirstChild=function(a){return a.firstChild?a.firstChild.nodeType===c.ELEMENT_NODE?c.getFirstChild(a.firstChild):a.firstChild:a},c.getLastChild=function(a){return a.lastChild?a.lastChild.nodeType===c.ELEMENT_NODE?c.getLastChild(a.lastChild):a.lastChild:a},c.removeEmptyNodes=function(a,b){for(var d=jQuery(a).find(":empty"),e=d.length;e>0;)e--,c.isStubElement(d[e])===!1&&(b&&b.call(this,d[e])===!1||c.remove(d[e]))},c.create=function(a){return jQuery(a)[0]},c.find=function(a,b){return jQuery(a).find(b)},c.children=function(a,b){return jQuery(a).children(b)},c.parent=function(a,b){return jQuery(a).parent(b)[0]},c.parents=function(a,b){return jQuery(a).parents(b)},c.is=function(a,b){return jQuery(a).is(b)},c.extend=function(a,b,c,d){return jQuery.extend.apply(this,arguments)},c.walk=function(a,b,d){if(a){d||(d=0);var e=b.call(this,a,d);e!==!1&&(a.childNodes&&a.childNodes.length>0?c.walk(a.firstChild,b,d+1):a.nextSibling?c.walk(a.nextSibling,b,d):a.parentNode&&a.parentNode.nextSibling&&c.walk(a.parentNode.nextSibling,b,d-1))}},c.revWalk=function(a,b){if(a){var d=b.call(this,a);d!==!1&&(a.childNodes&&a.childNodes.length>0?c.walk(a.lastChild,b):a.previousSibling?c.walk(a.previousSibling,b):a.parentNode&&a.parentNode.previousSibling&&c.walk(a.parentNode.previousSibling,b))}},c.setStyle=function(a,b,c){a&&jQuery(a).css(b,c)},c.getStyle=function(a,b){return jQuery(a).css(b)},c.hasClass=function(a,b){return jQuery(a).hasClass(b)},c.addClass=function(a,b){jQuery(a).addClass(b)},c.removeClass=function(a,b){jQuery(a).removeClass(b)},c.preventDefault=function(a){a.preventDefault(),c.stopPropagation(a)},c.stopPropagation=function(a){a.stopPropagation()},c.noInclusionInherits=function(a,b){(b instanceof String||"string"==typeof b)&&(b=window[b]),(a instanceof String||"string"==typeof a)&&(a=window[a]);var d=function(){};if(c.isset(b)===!0)for(value in b.prototype)a.prototype[value]?d.prototype[value]=b.prototype[value]:a.prototype[value]=b.prototype[value];a.prototype&&(d.prototype.constructor=b,a.prototype["super"]=new d)},c.each=function(a,b){jQuery.each(a,function(a,c){b.call(this,a,c)})},c.foreach=function(a,b){if(a instanceof Array||a instanceof NodeList||"undefined"!=typeof a.length&&"undefined"!=typeof a.item)for(var c=a.length,d=0;c>d;d++){var e=b.call(this,d,a[d]);if(e===!1)break}else for(var f in a)if(a.hasOwnProperty(f)===!0){var e=b.call(this,f);if(e===!1)break}},c.isBlank=function(a){return!a||/^\s*$/.test(a)?!0:!1},c.isFn=function(a){return"function"==typeof a?!0:!1},c.isObj=function(a){return null!==a&&"object"==typeof a?!0:!1},c.isset=function(a){return"undefined"!=typeof a&&null!==a?!0:!1},c.isArray=function(a){return jQuery.isArray(a)},c.isNumeric=function(a){var b=a.match(/^\d+$/);return null!==b?!0:!1},c.getUniqueId=function(){var a=(new Date).getTime(),b=Math.ceil(1e6*Math.random()),c=a+""+b;return c.substr(5,18).replace(/,/,"")},c.inArray=function(a,b){for(var c=b.length,d=0;c>d;d++)if(a===b[d])return!0;return!1},c.arrayDiff=function(a,b,d){for(var e=a.length,f=[],g=0;e>g;g++)c.inArray(a[g],b)===!1&&f.push(a[g]);if(d!==!0){e=b.length;for(var g=0;e>g;g++)c.inArray(b[g],a)===!1&&f.push(b[g])}return f},c.arrayMerge=function(a,b){for(var c=b.length,d=0;c>d;d++)a.push(b[d]);return a},c.stripTags=function(a,b){if("string"==typeof b){var d=jQuery("<div>"+a+"</div>");return d.find("*").not(b).remove(),d.html()}for(var e,f=new RegExp(/<\/?(\w+)((\s+\w+(\s*=\s*(?:".*?"|'.*?'|[^'">\s]+))?)+\s*|\s*)\/?>/gim),g=a;null!=(e=f.exec(a));)(c.isset(b)===!1||c.inArray(e[1],b)!==!0)&&(g=g.replace(e[0],""));return g},c.browser=function(){return b?$.extend({},b):(b=function(){function a(a){a=a.toLowerCase();var b=/(chrome)[ \/]([\w.]+)/.exec(a)||/(webkit)[ \/]([\w.]+)/.exec(a)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(a)||/(msie) ([\w.]+)/.exec(a)||a.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(a)||[];return{browser:b[1]||"",version:b[2]||"0"}}var b=navigator.userAgent.toLowerCase(),c=a(b),d={type:"unknown",version:0,msie:!1};return c.browser&&(d[c.browser]=!0,d.version=c.version||0,d.type=c.browser),d.chrome?d.webkit=!0:d.webkit&&(d.safari=!0),d.webkit&&(d.type="webkit"),d.firefox=1==/firefox/.test(b),d.msie||(d.msie=!!/trident/.test(b)),d}(),$.extend({},b))},c.getBrowserType=function(){if(null===this._browserType){for(var a=["msie","firefox","chrome","safari"],b=a.length,c=0;b>c;c++){var d=new RegExp(a[c],"i");if(d.test(navigator.userAgent)===!0)return this._browserType=a[c],this._browserType}this._browserType="other"}return this._browserType},c.getWebkitType=function(){if("webkit"!==c.browser().type)return console.log("Not a webkit!"),!1;var a=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0;return a?"safari":"chrome"},c.isBrowser=function(a){return c.browser().type===a},c.getBlockParent=function(a,b){if(c.isBlockElement(a)===!0)return a;if(a)for(;a.parentNode;){if(a=a.parentNode,a===b)return null;if(c.isBlockElement(a)===!0)return a}return null},c.findNodeParent=function(a,b,d){if(a)for(;a.parentNode;){if(a===d)return null;if(c.is(a,b)===!0)return a;a=a.parentNode}return null},c.onBlockBoundary=function(a,b,d){if(!a||!b)return!1;var e=c.isChildOfTagNames(a,d)||c.is(a,d.join(", "))&&a||null,f=c.isChildOfTagNames(b,d)||c.is(b,d.join(", "))&&b||null;return e!==f},c.isOnBlockBoundary=function(a,b,d){if(!a||!b)return!1;var e=c.getBlockParent(a,d)||c.isBlockElement(a,d)&&a||null,f=c.getBlockParent(b,d)||c.isBlockElement(b,d)&&b||null;return e!==f},c.mergeContainers=function(a,b){if(!a||!b)return!1;if(a.nodeType===c.TEXT_NODE||c.isStubElement(a))b.appendChild(a);else if(a.nodeType===c.ELEMENT_NODE){for(;a.firstChild;)b.appendChild(a.firstChild);c.remove(a)}return!0},c.mergeBlockWithSibling=function(a,b,d){var e=d?jQuery(b).next().get(0):jQuery(b).prev().get(0);return d?c.mergeContainers(e,b):c.mergeContainers(b,e),a.collapse(!0),!0},c.date=function(a,b,d){if(null!==b||!d||(b=c.tsIso8601ToTimestamp(d))){for(var e=new Date(b),f=a.split(""),g=f.length,h="",i=0;g>i;i++){var j="",k=f[i];switch(k){case"D":case"l":var l=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];j=l[e.getDay()],"D"===k&&(j=j.substring(0,3));break;case"F":case"m":j=e.getMonth()+1,10>j&&(j="0"+j);break;case"M":months=["January","February","March","April","May","June","July","August","September","October","November","December"],j=months[e.getMonth()],"M"===k&&(j=j.substring(0,3));break;case"d":j=e.getDate();break;case"S":j=c.getOrdinalSuffix(e.getDate());break;case"Y":j=e.getFullYear();break;case"y":j=e.getFullYear(),j=j.toString().substring(2);break;case"H":j=e.getHours();break;case"h":j=e.getHours(),0===j?j=12:j>12&&(j-=12);break;case"i":j=c.addNumberPadding(e.getMinutes());break;case"a":j="am",e.getHours()>=12&&(j="pm");break;default:j=k}h+=j}return h}},c.getOrdinalSuffix=function(a){var b="",c=a%100;if(c>=4&&20>=c)b="th";else switch(a%10){case 1:b="st";break;case 2:b="nd";break;case 3:b="rd";break;default:b="th"}return b},c.addNumberPadding=function(a){return 10>a&&(a="0"+a),a},c.tsIso8601ToTimestamp=function(a){var b=/(\d\d\d\d)(?:-?(\d\d)(?:-?(\d\d)(?:[T ](\d\d)(?::?(\d\d)(?::?(\d\d)(?:\.(\d+))?)?)?(?:Z|(?:([-+])(\d\d)(?::?(\d\d))?)?)?)?)?)?/,c=a.match(new RegExp(b));if(c){var d=new Date;d.setDate(c[3]),d.setFullYear(c[1]),d.setMonth(c[2]-1),d.setHours(c[4]),d.setMinutes(c[5]),d.setSeconds(c[6]);var e=60*c[9];"+"===c[8]&&(e*=-1),e-=d.getTimezoneOffset();var f=d.getTime()+60*e*1e3;return f}return null},a.dom=c}.call(this.ice),function(){var a,b=this;a=function(a,b,c){this.env=a,this.element=a.element,this.selection=this.env.selection,c||this.removeBookmarks(this.element);var d=b||this.selection.getRangeAt(0);b=d.cloneRange();var e,f=b.startContainer,g=(b.endContainer,b.startOffset);b.endOffset;b.collapse(!1);var h=this.env.document.createElement("span");h.style.display="none",ice.dom.setHtml(h,"&nbsp;"),ice.dom.addClass(h,"iceBookmark iceBookmark_end"),h.setAttribute("iceBookmark","end"),b.insertNode(h),ice.dom.isChildOf(h,this.element)||this.element.appendChild(h),b.setStart(f,g),b.collapse(!0);var i=this.env.document.createElement("span");i.style.display="none",ice.dom.addClass(i,"iceBookmark iceBookmark_start"),ice.dom.setHtml(i,"&nbsp;"),i.setAttribute("iceBookmark","start");try{b.insertNode(i),i.previousSibling===h&&(e=i,i=h,h=e)}catch(j){ice.dom.insertBefore(h,i)}ice.dom.isChildOf(i,this.element)===!1&&(this.element.firstChild?ice.dom.insertBefore(this.element.firstChild,i):this.element.appendChild(i)),h.previousSibling||(e=this.env.document.createTextNode(""),ice.dom.insertBefore(h,e)),i.nextSibling||(e=this.env.document.createTextNode(""),ice.dom.insertAfter(i,e)),d.setStart(i.nextSibling,0),d.setEnd(h.previousSibling,h.previousSibling.length||0),this.start=i,this.end=h},a.prototype={selectBookmark:function(){var a=this.selection.getRangeAt(0),b=null,c=null,d=0,e=null;if(this.start.nextSibling===this.end||0===ice.dom.getElementsBetween(this.start,this.end).length)this.end.nextSibling?b=ice.dom.getFirstChild(this.end.nextSibling):this.start.previousSibling?(b=ice.dom.getFirstChild(this.start.previousSibling),b.nodeType===ice.dom.TEXT_NODE&&(d=b.length)):(this.end.parentNode.appendChild(this.env.document.createTextNode("")),b=ice.dom.getFirstChild(this.end.nextSibling));else{if(this.start.nextSibling)b=ice.dom.getFirstChild(this.start.nextSibling);else{if(!this.start.previousSibling){var f=this.env.document.createTextNode("");ice.dom.insertBefore(this.start,f)}b=ice.dom.getLastChild(this.start.previousSibling),d=b.length}this.end.previousSibling?c=ice.dom.getLastChild(this.end.previousSibling):(c=ice.dom.getFirstChild(this.end.nextSibling||this.end),e=0)}ice.dom.remove([this.start,this.end]),null===c?(a.setEnd(b,d),a.collapse(!1)):(a.setStart(b,d),null===e&&(e=c.length||0),a.setEnd(c,e));try{this.selection.addRange(a)}catch(g){}},getBookmark:function(a,b){var c=ice.dom.getClass("iceBookmark_"+b,a)[0];return c},removeBookmarks:function(a){ice.dom.remove(ice.dom.getClass("iceBookmark",a,"span"))}},b.Bookmark=a}.call(this.ice),function(){var a,b=this;a=function(a){this._selection=null,this.env=a,this._initializeRangeLibrary(),this._getSelection()},a.prototype={_getSelection:function(){return this._selection?this._selection.refresh():this.env.frame?this._selection=rangy.getSelection(this.env.frame):this._selection=rangy.getSelection(),this._selection},createRange:function(){return rangy.createRange(this.env.document)},getRangeAt:function(a){this._selection.refresh();try{return this._selection.getRangeAt(a)}catch(b){return this._selection=null,this._getSelection().getRangeAt(0)}},addRange:function(a){this._selection||(this._selection=this._getSelection()),this._selection.setSingleRange(a),this._selection.ranges=[a]},_initializeRangeLibrary:function(){var a=this;rangy.init(),rangy.config.checkSelectionRanges=!1;var b=function(a,b,c,d){if(0!==c)switch(b){case ice.dom.CHARACTER_UNIT:c>0?a.moveCharRight(d,c):a.moveCharLeft(d,-1*c);break;case ice.dom.WORD_UNIT:}};rangy.rangePrototype.moveStart=function(a,c){b(this,a,c,!0);
},rangy.rangePrototype.moveEnd=function(a,c){b(this,a,c,!1)},rangy.rangePrototype.setRange=function(a,b,c){a?this.setStart(b,c):this.setEnd(b,c)},rangy.rangePrototype.moveCharLeft=function(a,b){var c,d;if(a?(c=this.startContainer,d=this.startOffset):(c=this.endContainer,d=this.endOffset),c.nodeType===ice.dom.ELEMENT_NODE)if(c.hasChildNodes()){for(c=c.childNodes[d],c=this.getPreviousTextNode(c);c&&c.nodeType==ice.dom.TEXT_NODE&&""===c.nodeValue;)c=this.getPreviousTextNode(c);d=c.data.length-b}else d=-1*b;else d-=b;if(0>d)for(;0>d;){var e=[];if(c=this.getPreviousTextNode(c,e),!c)return;c.nodeType!==ice.dom.ELEMENT_NODE&&(d+=c.data.length)}this.setRange(a,c,d)},rangy.rangePrototype.moveCharRight=function(a,b){var c,d;a?(c=this.startContainer,d=this.startOffset):(c=this.endContainer,d=this.endOffset),c.nodeType===ice.dom.ELEMENT_NODE?(c=c.childNodes[d],c.nodeType!==ice.dom.TEXT_NODE&&(c=this.getNextTextNode(c)),d=b):d+=b;var e=d-c.data.length;if(e>0){for(var f=[];e>0;)if(c=this.getNextContainer(c,f),c.nodeType!==ice.dom.ELEMENT_NODE){if(c.data.length>=e)break;c.data.length>0&&(e-=c.data.length)}d=e}this.setRange(a,c,d)},rangy.rangePrototype.getNextContainer=function(a,b){if(!a)return null;for(;a.nextSibling;)if(a=a.nextSibling,a.nodeType!==ice.dom.TEXT_NODE){var c=this.getFirstSelectableChild(a);if(null!==c)return c}else if(this.isSelectable(a)===!0)return a;for(;a&&!a.nextSibling;)a=a.parentNode;if(!a)return null;if(a=a.nextSibling,this.isSelectable(a)===!0)return a;b&&ice.dom.isBlockElement(a)===!0&&b.push(a);var d=this.getFirstSelectableChild(a);return null!==d?d:this.getNextContainer(a,b)},rangy.rangePrototype.getPreviousContainer=function(a,b){if(!a)return null;for(;a.previousSibling;)if(a=a.previousSibling,a.nodeType!==ice.dom.TEXT_NODE){if(ice.dom.isStubElement(a)===!0)return a;var c=this.getLastSelectableChild(a);if(null!==c)return c}else if(this.isSelectable(a)===!0)return a;for(;a&&!a.previousSibling;)a=a.parentNode;if(!a)return null;if(a=a.previousSibling,this.isSelectable(a)===!0)return a;b&&ice.dom.isBlockElement(a)===!0&&b.push(a);var d=this.getLastSelectableChild(a);return null!==d?d:this.getPreviousContainer(a,b)},rangy.rangePrototype.getNextTextNode=function(a){return a.nodeType===ice.dom.ELEMENT_NODE&&0!==a.childNodes.length?this.getFirstSelectableChild(a):(a=this.getNextContainer(a),a.nodeType===ice.dom.TEXT_NODE?a:this.getNextTextNode(a))},rangy.rangePrototype.getPreviousTextNode=function(a,b){return a=this.getPreviousContainer(a,b),a.nodeType===ice.dom.TEXT_NODE?a:this.getPreviousTextNode(a,b)},rangy.rangePrototype.getFirstSelectableChild=function(a){if(a){if(a.nodeType===ice.dom.TEXT_NODE)return a;for(var b=a.firstChild;b;){if(this.isSelectable(b)===!0)return b;if(b.firstChild){var c=this.getFirstSelectableChild(b);if(null!==c)return c;b=b.nextSibling}else b=b.nextSibling}}return null},rangy.rangePrototype.getLastSelectableChild=function(a){if(a){if(a.nodeType===ice.dom.TEXT_NODE)return a;for(var b=a.lastChild;b;){if(this.isSelectable(b)===!0)return b;if(b.lastChild){var c=this.getLastSelectableChild(b);if(null!==c)return c;b=b.previousSibling}else b=b.previousSibling}}return null},rangy.rangePrototype.isSelectable=function(a){return a&&a.nodeType===ice.dom.TEXT_NODE&&0!==a.data.length?!0:!1},rangy.rangePrototype.getHTMLContents=function(b){b||(b=this.cloneContents());var c=a.env.document.createElement("div");return c.appendChild(b.cloneNode(!0)),c.innerHTML},rangy.rangePrototype.getHTMLContentsObj=function(){return this.cloneContents()}}},b.Selection=a}.call(this.ice),function(){var a=this,b=function(a){this._ice=a};b.prototype={start:function(){},clicked:function(a){return!0},mouseDown:function(a){return!0},keyDown:function(a){return!0},keyPress:function(a){return!0},selectionChanged:function(a){},setEnabled:function(a){},setDisabled:function(a){},caretUpdated:function(){},nodeInserted:function(a,b){},nodeCreated:function(a,b){},caretPositioned:function(){},remove:function(){this._ice.removeKeyPressListener(this)},setSettings:function(a){}},a.IcePlugin=b}.call(this.ice),function(){var a=this,b=function(a){this.plugins={},this.pluginConstructors={},this.keyPressListeners={},this.activePlugin=null,this.pluginSets={},this.activePluginSet=null,this._ice=a};b.prototype={getPluginNames:function(){var a=[];for(var b in this.plugins)a.push(b);return a},addPluginObject:function(a,b){this.plugins[a]=b},addPlugin:function(a,b){if("function"!=typeof b)throw Error("IcePluginException: plugin must be a constructor function");ice.dom.isset(this.pluginConstructors[a])===!1&&(this.pluginConstructors[a]=b)},loadPlugins:function(a,b){if(0===a.length)b.call(this);else{var c=a.shift();if("object"==typeof c&&(c=c.name),ice.dom.isset(ice._plugin[c])!==!0)throw new Error("plugin was not included in the page: "+c);this.addPlugin(c,ice._plugin[c]),this.loadPlugins(a,b)}},_enableSet:function(a){this.activePluginSet=a;for(var b=this.pluginSets[a].length,c=0;b>c;c++){var d=this.pluginSets[a][c],e="";e="object"==typeof d?d.name:d;var f=this.pluginConstructors[e];if(f){var g=new f(this._ice);this.plugins[e]=g,ice.dom.isset(d.settings)===!0&&g.setSettings(d.settings),g.start()}}},setActivePlugin:function(a){this.activePlugin=a},getActivePlugin:function(){return this.activePlugin},_getPluginName:function(a){var b=a.toString(),c="function ".length,d=b.substr(c,b.indexOf("(")-c);return d},removePlugin:function(a){this.plugins[a]&&this.plugins[a].remove()},getPlugin:function(a){return this.plugins[a]},usePlugins:function(a,b,c){var d=this;ice.dom.isset(b)===!0?this.pluginSets[a]=b:this.pluginSets[a]=[];var e=this.pluginSets[a].concat([]);this.loadPlugins(e,function(){d._enableSet(a),c&&c.call(this)})},disablePlugin:function(a){this.plugins[a].disable()},isPluginElement:function(a){for(var b in this.plugins)if(this.plugins[b].isPluginElement&&this.plugins[b].isPluginElement(a)===!0)return!0;return!1},fireKeyPressed:function(a){if(this._fireKeyPressFns(a,"all_keys")===!1)return!1;var b=[];switch((a.ctrlKey===!0||a.metaKey===!0)&&b.push("ctrl"),a.shiftKey===!0&&b.push("shift"),a.altKey===!0&&b.push("alt"),a.keyCode){case ice.dom.DOM_VK_RETURN:b.push("enter");break;case ice.dom.DOM_VK_LEFT:b.push("left");break;case ice.dom.DOM_VK_RIGHT:b.push("right");break;case ice.dom.DOM_VK_UP:b.push("up");break;case ice.dom.DOM_VK_DOWN:b.push("down");break;case ice.dom.DOM_VK_TAB:b.push("tab");break;case ice.dom.DOM_VK_BACK_SPACE:b.push("delete");break;default:var c;a.keyCode?c=a.keyCode:a.which&&(c=a.which),c&&b.push(String.fromCharCode(c).toLowerCase())}var d=b.sort().join("+");return this._fireKeyPressFns(a,d)},_fireKeyPressFns:function(a,b){if(this.keyPressListeners[b])for(var c=this.keyPressListeners[b].length,d=0;c>d;d++){var e=this.keyPressListeners[b][d],f=e.fn,g=e.plugin,h=e.data;if(f)if(ice.dom.isFn(f)===!0){if(f.call(g,a,h)===!0)return ice.dom.preventDefault(a),!1}else if(g[f]&&g[f].call(g,a,h)===!0)return ice.dom.preventDefault(a),!1}return!0},fireSelectionChanged:function(a){for(var b in this.plugins)this.plugins[b].selectionChanged(a)},fireNodeInserted:function(a,b){for(var c in this.plugins)if(this.plugins[c].nodeInserted(a,b)===!1)return!1},fireNodeCreated:function(a,b){for(var c in this.plugins)if(this.plugins[c].nodeCreated(a,b)===!1)return!1},fireCaretPositioned:function(){for(var a in this.plugins)this.plugins[a].caretPositioned()},fireClicked:function(a){var b=!0;for(var c in this.plugins)this.plugins[c].clicked(a)===!1&&(b=!1);return b},fireMouseDown:function(a){var b=!0;for(var c in this.plugins)this.plugins[c].mouseDown(a)===!1&&(b=!1);return b},fireKeyDown:function(a){var b=!0;for(var c in this.plugins)this.plugins[c].keyDown(a)===!1&&(b=!1);return b},fireKeyPress:function(a){var b=!0;for(var c in this.plugins)this.plugins[c].keyPress(a)===!1&&(b=!1);return b},fireEnabled:function(a){for(var b in this.plugins)this.plugins[b].setEnabled(a)},fireDisabled:function(a){for(var b in this.plugins)this.plugins[b].setDisabled(a)},fireCaretUpdated:function(){for(var a in this.plugins)this.plugins[a].caretUpdated&&this.plugins[a].caretUpdated()}},a._plugin={},a.IcePluginManager=b}.call(this.ice),function(){var a,b=this;a=function(a){this._ice=a},a.prototype={nodeCreated:function(a,b){a.setAttribute("title",(b.action||"Modified")+" by "+a.getAttribute(this._ice.userNameAttribute)+" - "+ice.dom.date(this._ice.titleDateFormat,parseInt(a.getAttribute(this._ice.timeAttribute))))}},ice.dom.noInclusionInherits(a,ice.IcePlugin),b._plugin.IceAddTitlePlugin=a}.call(this.ice),function(){var a,b=this;a=function(a){this._ice=a,this._tmpNode=null,this._pasteTmpNodeTagName="icepaste",this._pasteId="icepastediv",this._pasteElement=null,this._cutId="icecutdiv",this._cutElement=null;var b=this;this.pasteType="formattedClean",this.preserve="p",this.beforePasteClean=function(a){return a},this.afterPasteClean=function(a){return a},a.element.oncopy=function(){return b.handleCopy.apply(b)}},a.prototype={setSettings:function(a){a=a||{},ice.dom.extend(this,a),this.preserve+=","+this._pasteTmpNodeTagName,this.setupPreserved()},keyDown:function(a){return a.metaKey===!0||a.ctrlKey===!0?(a.keyCode==ice.dom.DOM_VK_V?this.handlePaste(a):a.keyCode==ice.dom.DOM_VK_X&&this.handleCut(a),!0):void 0},handleCopy:function(a){},handlePaste:function(a){var b=this._ice.getCurrentRange();if(b.collapsed||(this._ice.isTracking?(this._ice.deleteContents(),b=b.cloneRange()):(b.deleteContents(),b.collapse(!0))),this._ice.isTracking&&this._ice._moveRangeToValidTrackingPos(b),b.startContainer==this._ice.element){var c=ice.dom.find(this._ice.element,this._ice.blockEl)[0];c||(c=ice.dom.create("<"+this._ice.blockEl+" ><br/></"+this._ice.blockEl+">"),this._ice.element.appendChild(c)),b.setStart(c,0),b.collapse(!0),this._ice.env.selection.addRange(b)}switch(this._tmpNode=this._ice.env.document.createElement(this._pasteTmpNodeTagName),b.insertNode(this._tmpNode),this.pasteType){case"formatted":this.setupPaste();break;case"formattedClean":this.setupPaste(!0)}return!0},setupPaste:function(a){this._pasteElement=this.createDiv(this._pasteId);var b=this,c=this._ice.getCurrentRange();return c.selectNodeContents(this._pasteElement),this._ice.selection.addRange(c),this._pasteElement.onpaste=function(c){setTimeout(function(){b.handlePasteValue(a)},0),c.stopPropagation()},this._pasteElement.focus(),!0},handlePasteValue:function(a){var b=this._ice.env.document,c=b.getElementById(this._pasteId),d=ice.dom.getHtml(c),e=ice.dom.children("<div>"+d+"</div>",this._ice.blockEl);1===e.length&&ice.dom.getNodeTextContent("<div>"+d+"</div>")===ice.dom.getNodeTextContent(e)&&(d=ice.dom.getHtml(d)),d=this.beforePasteClean.call(this,d),a&&(d=this._ice.getCleanContent(d),d=this.stripPaste(d)),d=this.afterPasteClean.call(this,d),d=ice.dom.trim(d);var f=this._ice.getCurrentRange();f.setStartAfter(this._tmpNode),f.collapse(!0);var g=null,h=null,i=null,j=f.createContextualFragment(d),k=this._ice.startBatchChange();if(ice.dom.hasBlockChildren(j)){var l=ice.dom.isChildOfTagName(this._tmpNode,this._ice.blockEl);f.setEndAfter(l.lastChild),this._ice.selection.addRange(f);var m=f.extractContents(),n=b.createElement(this._ice.blockEl);n.appendChild(m),ice.dom.insertAfter(l,n),f.setStart(n,0),f.collapse(!0),this._ice.selection.addRange(f);for(var o=f.startContainer;j.firstChild;)if(3!==j.firstChild.nodeType||jQuery.trim(j.firstChild.nodeValue))if(ice.dom.isBlockElement(j.firstChild)){if(""!==j.firstChild.textContent){g=null;var p=null;this._ice.isTracking?(p=this._ice.createIceNode("insertType"),this._ice.addChange("insertType",[p]),i=b.createElement(j.firstChild.tagName),p.innerHTML=j.firstChild.innerHTML,i.appendChild(p)):(p=i=b.createElement(j.firstChild.tagName),i.innerHTML=j.firstChild.innerHTML),h=p,ice.dom.each(j.firstChild.attributes,function(){i.setAttribute(this.name,this.value)}),ice.dom.insertBefore(o,i)}j.removeChild(j.firstChild)}else g||(i=b.createElement(this._ice.blockEl),ice.dom.insertBefore(o,i),this._ice.isTracking?(g=this._ice.createIceNode("insertType"),this._ice.addChange("insertType",[g]),i.appendChild(g)):g=i),h=g,g.appendChild(j.removeChild(j.firstChild));else j.removeChild(j.firstChild);n.textContent||n.parentNode.removeChild(n)}else if(this._ice.isTracking)i=this._ice.createIceNode("insertType",j),this._ice.addChange("insertType",[i]),f.insertNode(i),h=i;else for(var q;q=j.firstChild;)f.insertNode(q),f.setStartAfter(q),f.collapse(!0),h=q;this._ice.endBatchChange(k),c.parentNode.removeChild(c),this._cleanup(h)},createDiv:function(a){var b=this._ice.env.document,c=b.getElementById(a);c&&ice.dom.remove(c);var d=b.createElement("div");return d.id=a,d.setAttribute("contentEditable",!0),ice.dom.setStyle(d,"width","1px"),ice.dom.setStyle(d,"height","1px"),ice.dom.setStyle(d,"overflow","hidden"),ice.dom.setStyle(d,"position","fixed"),ice.dom.setStyle(d,"top","10px"),ice.dom.setStyle(d,"left","10px"),d.appendChild(b.createElement("br")),b.body.appendChild(d),d},handleCut:function(a){var b=this,c=this._ice.getCurrentRange();if(c.collapsed)return!1;this._cutElement=this.createDiv(this._cutId),this._cutElement.innerHTML=c.getHTMLContents().replace(/ </g,"&nbsp;<").replace(/> /g,">&nbsp;"),this._ice.isTracking?this._ice.deleteContents():c.deleteContents();var d=this._ice.env.document.createRange();return d.setStart(this._cutElement.firstChild,0),d.setEndAfter(this._cutElement.lastChild),setTimeout(function(){b._cutElement.focus(),setTimeout(function(){ice.dom.remove(b._cutElement),c.setStart(c.startContainer,c.startOffset),c.collapse(!1),b._ice.env.selection.addRange(c)},100)},0),b._ice.env.selection.addRange(d),!0},stripPaste:function(a){return a=this._cleanWordPaste(a),a=this.cleanPreserved(a)},setupPreserved:function(){var a=this;this._tags="",this._attributesMap=[],ice.dom.each(this.preserve.split(","),function(b,c){c.match(/(\w+)(\[(.+)\])?/);var d=RegExp.$1,e=RegExp.$3;a._tags&&(a._tags+=","),a._tags+=d.toLowerCase(),a._attributesMap[d]=e.split("|")})},cleanPreserved:function(a){var b=this,c=this._ice.env.document.createElement("div");return c.innerHTML=a,c=ice.dom.stripEnclosingTags(c,this._tags),ice.dom.each(ice.dom.find(c,this._tags),function(a,c){if(ice.dom.hasClass(c,"skip-clean"))return!0;var d=c.tagName.toLowerCase(),e=b._attributesMap[d];if(e[0]&&"*"===e[0])return!0;if(c.hasAttributes())for(var f=c.attributes,a=f.length-1;a>=0;a--)ice.dom.inArray(f[a].name,e)||c.removeAttribute(f[a].name)}),c.innerHTML},_cleanWordPaste:function(a){return a=a.replace(/<(meta|link)[^>]+>/g,""),a=a.replace(/<!--(.|\s)*?-->/g,""),a=a.replace(/<style>[\s\S]*?<\/style>/g,""),a=a.replace(/<\/?\w+:[^>]*>/gi,""),a=a.replace(/<\\?\?xml[^>]*>/gi,""),a=this._cleanPaste(a),a=a.replace(/<(\w[^>]*) (lang)=([^ |>]*)([^>]*)/gi,"<$1$4")},_cleanPaste:function(a){return a=a.replace(/<b(\s+|>)/g,"<strong$1"),a=a.replace(/<\/b(\s+|>)/g,"</strong$1"),a=a.replace(/<i(\s+|>)/g,"<em$1"),a=a.replace(/<\/i(\s+|>)/g,"</em$1")},_cleanup:function(a){try{this._ice.env.frame?this._ice.env.frame.contentWindow.focus():this._ice.element.focus(),a=a&&a.lastChild||a||this._tmpNode;var b=this._ice.getCurrentRange();b.setStartAfter(a),b.collapse(!0),this._ice.selection.addRange(b),this._tmpNode.parentNode.removeChild(this._tmpNode),this._tmpNode=null;for(var c=this._ice.env.document.getElementsByClassName(this._ice.changeTypes.insertType.alias),d=0;d<c.length;d++)c[d].textContent||c[d].parentNode&&c[d].parentNode.removeChild(c[d])}catch(e){window.console&&console.error(e)}}},ice.dom.noInclusionInherits(a,ice.IcePlugin),b._plugin.IceCopyPastePlugin=a}.call(this.ice),function(){var a=this,b=this.ice,c=function(a){this._ice=a};c.prototype={convert:function(a){var c=this;try{c._ice.placeholdDeletes(),b.dom.each(a.getElementsByTagName(this._ice.blockEl),function(a,b){c._convertBlock(b)})}catch(d){window.console&&console.error(d)}finally{c._ice.revertDeletePlaceholders()}},_convertBlock:function(a){if(!(b.dom.getNodeTextContent(a)<2)){var c,d,e,f,g,h="'",i='"',j=String.fromCharCode(8216),k=String.fromCharCode(8217),l=String.fromCharCode(8220),m=String.fromCharCode(8221),n=function(a){return/\d/.test(a)},o=function(a){return/\w/.test(a)},p=function(a){return a===String.fromCharCode(160)||a===String.fromCharCode(32)},q=function(a){return p(a)||"("===a},r=function(a){return p(a)||null==a||";"===a||")"===a||"."==a||"!"===a||","===a||"?"===a||":"===a},s=function(a){return!p(a)},t=function(a){return a===h||a===j||a===k};f=b.dom.getHtml(a).match(/(<("[^"]*"|'[^']*'|[^'">])*>|&.*;|.)/g),g=function(a,b,c){var d=a.length,e=0>c?-1:1;return function f(a,b,c){if(0>b||b>=d)return null;var g=a[b+e];return g&&1==g.length&&(c+=-1*e,!c)?g:f(a,b+e,c)}(a,b,c)},b.dom.each(f,function(a,b){if("&nbsp;"==b&&(b=f[a]=" "),1==b.length){switch(c=g(f,a,-1),d=b,e=g(f,a,1),d){case j:case k:d=h;case h:(null==c||p(c))&&n(e)&&n(g(f,a,2))&&r(g(f,a,3))?d=k:null==c||q(c)&&s(e)?d=j:null==e||s(c)&&r(e)?d=k:o(c)&&o(e)&&(d=k);break;case l:case m:d=i;case i:r(e)&&p(c)&&t(g(f,a,-2))?d=m:null==c||q(c)&&s(e)?d=l:null==e||s(c)&&r(e)?d=m:(null==c||p(c))&&p(e)&&t(g(f,a,1))&&(d=l)}null!=d&&(f[a]=d)}}),b.dom.setHtml(a,f.join(""))}}},b.dom.noInclusionInherits(c,b.IcePlugin),a.ice._plugin.IceSmartQuotesPlugin=c}.call(this),function(){var a=this,b=function(a){this._ice=a};b.prototype={keyDown:function(a){if(ice.dom.isBrowser("mozilla")){var b=parseInt(ice.dom.browser().version);if(b>14&&a.keyCode===ice.dom.DOM_VK_HYPHEN_MINUS||14>=b&&a.keyCode===ice.dom.DOM_VK_PERIOD)return this.convertEmdash(a)}else if(a.keyCode===ice.dom.DOM_VK_DASH)return this.convertEmdash(a);return!0},convertEmdash:function(a){var b=this._ice.getCurrentRange();if(b.collapsed){try{b.moveStart(ice.dom.CHARACTER_UNIT,-1);var d=ice.dom.getParents(b.startContainer,this._ice.blockEl)[0],e=ice.dom.getParents(b.endContainer,this._ice.blockEl)[0];if(d===e&&!this._ice.getIceNode(b.startContainer,"deleteType")&&(c=b.toHtml(),"-"===c)){b.extractContents(),b.collapse();var f=this._ice.env.document.createTextNode("\u2014");return this._ice.isTracking?this._ice._insertNode(f,b):(b.insertNode(f),b.setStart(f,1),b.collapse(!0)),this._ice._preventKeyPress=!0,!1}}catch(a){}b.collapse()}return!0}},ice.dom.noInclusionInherits(b,ice.IcePlugin),a._plugin.IceEmdashPlugin=b}.call(this.ice);